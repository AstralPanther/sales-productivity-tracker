<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Points Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: clamp(9px, 2.5vw, 12px);
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
            user-select: none;
            width: 400px;
            height: 125px;
            margin: 20px;
            resize: both;
            min-width: 300px;
            min-height: 110px;
        }

        .tracker-container {
            width: calc(100% - 4px);
            height: 100%;
            padding: 1px 2vw 0px 2vw;
            position: relative;
            overflow: hidden;
        }

        .progress-bar-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: space-between;
            padding: 1px 0 0 0;
            gap: 1px;
        }

        .time-markers {
            position: relative;
            height: 12px;
            margin-bottom: 1px;
        }

        .time-marker {
            position: absolute;
            font-size: clamp(8px, 2vw, 11px);
            color: #666;
            font-weight: 500;
            text-align: center;
            min-width: 20px;
            transform: translateX(-50%);
        }

        .progress-bar {
            flex: 1;
            position: relative;
            background: #e0e0e0;
            border-radius: 3px;
            height: clamp(12px, 15vh, 24px);
            overflow: hidden;
            cursor: pointer;
            min-height: 12px;
            border: 1px solid #ddd;
            display: flex;
            align-items: stretch;
            margin: 0;
        }

        .bar-label {
            position: absolute;
            left: 6px;
            top: 50%;
            transform: translateY(-50%);
            font-size: clamp(8px, 2vw, 11px);
            color: #555;
            font-weight: 500;
            z-index: 5;
            pointer-events: none;
        }

        .activity-fill {
            height: 100% !important;
            min-height: 10px;
            border-radius: 3px;
            transition: width 0.3s ease, background-color 0.3s ease;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            background: #ccc;
            min-width: 2px;
            display: block !important;
            box-sizing: border-box;
        }

        .activity-fill.behind {
            background: linear-gradient(90deg, #ff4444, #ff6666);
        }

        .activity-fill.close {
            background: linear-gradient(90deg, #ffaa00, #ffcc44);
        }

        .activity-fill.ahead {
            background: linear-gradient(90deg, #44aa44, #66cc66);
        }

        .activity-fill.complete {
            background: linear-gradient(90deg, #ffd700, #ffed4e);
        }

        .expected-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #ffff00, #ff8800);
            border-left: 1px solid rgba(0,0,0,0.3);
            border-right: 1px solid rgba(0,0,0,0.3);
            z-index: 10;
            transition: left 0.3s ease;
            box-shadow: 0 0 3px rgba(255, 136, 0, 0.6);
        }

        .points-display {
            position: absolute;
            top: 50%;
            right: 6px;
            transform: translateY(-50%);
            font-weight: bold;
            font-size: clamp(8px, 2vw, 12px);
            color: #333;
            z-index: 15;
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
            pointer-events: none;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 2000;
            min-width: 120px;
            display: none;
        }

        .menu-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 11px;
            transition: background-color 0.2s;
        }

        .menu-item:hover {
            background: #f0f0f0;
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 80px;
            left: 20px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 350px;
            display: none;
        }

        .settings-panel h3 {
            margin-bottom: 12px;
            font-size: 13px;
            color: #333;
        }

        .setting-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .setting-row label {
            font-size: 11px;
            color: #555;
            min-width: 50px;
        }

        .setting-row input {
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
            flex: 1;
        }

        .setting-buttons {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        .setting-buttons button {
            flex: 1;
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            background: white;
            transition: background-color 0.2s;
        }

        .setting-buttons button:hover {
            background: #f0f0f0;
        }

        #saveSettings {
            background: #2196f3;
            color: white;
            border-color: #2196f3;
        }

        #saveSettings:hover {
            background: #1976d2;
        }

        .dialog {
            position: fixed;
            top: 80px;
            left: 20px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none;
        }

        .dialog-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .dialog-row label {
            font-size: 11px;
            color: #333;
        }

        .dialog-row input {
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
            width: 60px;
        }

        .dialog-row button {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            background: white;
        }
    </style>
</head>
<body>
    <div class="tracker-container">
        <div class="progress-bar-container">
            <div class="time-markers">
                <span class="time-marker" data-hour="09">09</span>
                <span class="time-marker" data-hour="10">10</span>
                <span class="time-marker" data-hour="11">11</span>
                <span class="time-marker" data-hour="12">12</span>
                <span class="time-marker" data-hour="13">13</span>
                <span class="time-marker" data-hour="14">14</span>
                <span class="time-marker" data-hour="15">15</span>
                <span class="time-marker" data-hour="16">16</span>
                <span class="time-marker" data-hour="17">17</span>
            </div>
            
            <div class="progress-bar" id="activityBar">
                <div class="activity-fill" id="activityFill"></div>
                <div class="expected-line" id="expectedLine1"></div>
                <div class="bar-label">Activity</div>
                <div class="points-display" id="activityDisplay">0/50</div>
            </div>
            
            <div class="progress-bar" id="callsBar">
                <div class="activity-fill" id="callsFill"></div>
                <div class="expected-line" id="expectedLine2"></div>
                <div class="bar-label">Outbound Calls</div>
                <div class="points-display" id="callsDisplay">0/20</div>
            </div>
            
            <div class="progress-bar" id="backlogBar">
                <div class="activity-fill" id="backlogFill"></div>
                <div class="expected-line" id="expectedLine3"></div>
                <div class="bar-label">Backlog</div>
                <div class="points-display" id="backlogDisplay">0/0</div>
            </div>
            
            <div class="progress-bar" id="dailyRevenueBar">
                <div class="activity-fill" id="dailyRevenueFill"></div>
                <div class="expected-line" id="expectedLine4"></div>
                <div class="bar-label">Daily Revenue</div>
                <div class="points-display" id="dailyRevenueDisplay">$0</div>
            </div>
            
            <div class="progress-bar" id="monthlyRevenueBar">
                <div class="activity-fill" id="monthlyRevenueFill"></div>
                <div class="expected-line" id="expectedLine5"></div>
                <div class="bar-label">Monthly Revenue</div>
                <div class="points-display" id="monthlyRevenueDisplay">$0</div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="menu-item" onclick="openSettings()">Settings</div>
        <div class="menu-item" onclick="openRevenueGoals()">Revenue Goals</div>
    </div>

    <!-- Combined Input Dialog -->
    <div class="dialog" id="combinedDialog">
        <div class="dialog-row">
            <label>Activity:</label>
            <input type="number" id="activityInput" min="0" max="200" value="0">
            <label>Calls:</label>
            <input type="number" id="callsInput" min="0" max="100" value="0">
            <label>Backlog:</label>
            <input type="number" id="backlogInput" min="0" max="1000" value="0">
        </div>
        <div class="dialog-row">
            <label>Daily Rev:</label>
            <input type="number" id="dailyRevenueInput" min="0" max="100000" value="0" step="100">
            <label>Monthly Rev:</label>
            <input type="number" id="monthlyRevenueInput" min="0" max="1000000" value="0" step="1000">
            <button onclick="saveCombined()">Save</button>
            <button onclick="closeDialog()">Cancel</button>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <h3>Shift Settings</h3>
        <div class="setting-row">
            <label>Start:</label>
            <input type="time" id="startTimeInput" value="09:00">
            <button id="lockButton" onclick="toggleEndTimeLock()">🔓</button>
        </div>
        <div class="setting-row">
            <label>End:</label>
            <input type="time" id="endTimeInput" value="17:00">
        </div>
        <div class="setting-row">
            <label>Activity Target:</label>
            <input type="number" id="targetInput" min="1" max="200" value="50">
        </div>
        <div class="setting-row">
            <label>Calls Target:</label>
            <input type="number" id="callsTargetInput" min="1" max="100" value="20">
        </div>
        <div class="setting-row">
            <label>📋 Backlog Target:</label>
            <input type="number" id="backlogTargetInput" min="0" max="1000" value="0">
        </div>
        <div class="setting-row">
            <label>💰 Daily Revenue:</label>
            <input type="number" id="dailyRevenueTargetInput" min="0" max="100000" value="5000" step="100">
        </div>
        <div class="setting-row">
            <label>📈 Monthly Revenue:</label>
            <input type="number" id="monthlyRevenueTargetInput" min="0" max="1000000" value="50000" step="1000">
        </div>
        <div class="setting-buttons">
            <button id="saveSettings" onclick="saveSettings()">Save</button>
            <button onclick="closeSettings()">Cancel</button>
        </div>
    </div>

    <!-- Revenue Goals Panel -->
    <div class="settings-panel" id="revenueGoalsPanel" style="min-width: 500px; max-height: 400px; overflow-y: auto;">
        <h3>Purchase Goals & Revenue Planning</h3>
        
        <!-- Commission Settings -->
        <div style="background: #f8f8f8; padding: 8px; border-radius: 4px; margin-bottom: 12px;">
            <div class="setting-row">
                <label>Commission Rate:</label>
                <input type="number" id="commissionRate" min="0" max="0.1" step="0.0001" value="0.0025" style="width: 80px;">
                <span style="font-size: 10px; color: #666;">%</span>
                <label style="margin-left: 16px;">Tax Rate:</label>
                <input type="number" id="taxRate" min="0" max="0.5" step="0.001" value="0.325" style="width: 80px;">
                <span style="font-size: 10px; color: #666;">%</span>
            </div>
        </div>
        
        <!-- Add New Goal -->
        <div style="border: 1px solid #ddd; padding: 8px; border-radius: 4px; margin-bottom: 12px;">
            <div class="setting-row">
                <label>Item Name:</label>
                <input type="text" id="newGoalName" placeholder="Gaming Laptop" style="flex: 2;">
                <label>Cost:</label>
                <input type="number" id="newGoalCost" placeholder="1200" min="1" step="1" style="width: 80px;">
                <button onclick="addPurchaseGoal()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">Add</button>
            </div>
        </div>
        
        <!-- Goals List -->
        <div id="purchaseGoalsList" style="min-height: 100px; max-height: 200px; overflow-y: auto;">
            <!-- Goals will be populated here -->
        </div>
        
        <!-- Monthly Progress Visualization -->
        <div style="margin-top: 12px; padding: 8px; background: #f0f8ff; border-radius: 4px;">
            <h4 style="margin: 0 0 8px 0; font-size: 12px; color: #333;">Monthly Revenue Path</h4>
            <div id="revenuePath" style="background: white; border: 1px solid #ddd; border-radius: 3px; height: 60px; position: relative; overflow: hidden;">
                <!-- Progress visualization will be here -->
            </div>
            <div id="revenuePathLabels" style="font-size: 10px; color: #666; margin-top: 4px;">
                <!-- Labels will be here -->
            </div>
        </div>
        
        <div class="setting-buttons">
            <button onclick="updateCommissionSettings()">Update Settings</button>
            <button onclick="closeRevenueGoals()">Close</button>
        </div>
    </div>

    <script>
        // Commission and Purchase Goal Utilities
        class RevenueCalculator {
            constructor(commissionRate = 0.0025, taxRate = 0.325) {
                this.commissionRate = commissionRate;  // 0.25%
                this.taxRate = taxRate;                 // 32.5%
                this.netRate = commissionRate * (1 - taxRate);  // Final rate after tax
            }
            
            // Calculate net income from gross revenue
            calculateNetIncome(revenue) {
                return revenue * this.netRate;
            }
            
            // Calculate required revenue for desired net income
            calculateRequiredRevenue(netIncome) {
                return netIncome / this.netRate;
            }
            
            // Calculate required revenue for purchase cost
            calculateRevenueForPurchase(purchaseCost) {
                return this.calculateRequiredRevenue(purchaseCost);
            }
        }

        class PurchaseGoalManager {
            constructor() {
                this.goals = [];
                this.calculator = new RevenueCalculator();
                this.storageKey = 'purchaseGoals';
                this.load();
            }
            
            load() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        this.goals = JSON.parse(stored);
                        this.goals.forEach(goal => {
                            if (!goal.id) goal.id = this.generateId();
                            if (!goal.requiredRevenue) {
                                goal.requiredRevenue = Math.round(this.calculator.calculateRevenueForPurchase(goal.cost));
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading purchase goals:', error);
                    this.goals = [];
                }
            }
            
            save() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.goals));
                } catch (error) {
                    console.error('Error saving purchase goals:', error);
                }
            }
            
            generateId() {
                return 'goal_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            addGoal(name, cost) {
                const goal = {
                    id: this.generateId(),
                    name: name.trim(),
                    cost: parseFloat(cost),
                    requiredRevenue: Math.round(this.calculator.calculateRevenueForPurchase(cost)),
                    purchased: false,
                    order: this.goals.length,
                    createdAt: new Date().toISOString()
                };
                
                this.goals.push(goal);
                this.save();
                return goal;
            }
            
            removeGoal(goalId) {
                this.goals = this.goals.filter(goal => goal.id !== goalId);
                this.reorderGoals();
                this.save();
            }
            
            updateGoal(goalId, updates) {
                const goal = this.goals.find(g => g.id === goalId);
                if (goal) {
                    if (updates.name !== undefined) goal.name = updates.name.trim();
                    if (updates.cost !== undefined) {
                        goal.cost = parseFloat(updates.cost);
                        goal.requiredRevenue = Math.round(this.calculator.calculateRevenueForPurchase(goal.cost));
                    }
                    if (updates.purchased !== undefined) goal.purchased = updates.purchased;
                    this.save();
                }
                return goal;
            }
            
            reorderGoals() {
                this.goals.forEach((goal, index) => {
                    goal.order = index;
                });
                this.save();
            }
            
            moveGoal(fromIndex, toIndex) {
                if (fromIndex === toIndex) return;
                
                const [movedGoal] = this.goals.splice(fromIndex, 1);
                this.goals.splice(toIndex, 0, movedGoal);
                this.reorderGoals();
            }
            
            getGoalsSorted() {
                return [...this.goals].sort((a, b) => {
                    // Purchased goals always come first, then by order
                    if (a.purchased && !b.purchased) return -1;
                    if (!a.purchased && b.purchased) return 1;
                    return a.order - b.order;
                });
            }
            
            calculateProgress(currentRevenue) {
                const sortedGoals = this.getGoalsSorted();
                let cumulativeRevenue = 0;
                
                return sortedGoals.map((goal, index) => {
                    const startRevenue = cumulativeRevenue;
                    cumulativeRevenue += goal.requiredRevenue;
                    
                    return {
                        ...goal,
                        startRevenue,
                        endRevenue: cumulativeRevenue,
                        progress: Math.max(0, Math.min(1, (currentRevenue - startRevenue) / goal.requiredRevenue)),
                        achieved: currentRevenue >= cumulativeRevenue
                    };
                });
            }
        }

        class ActivityTracker {
            constructor() {
                this.currentPoints = 0;
                this.currentCalls = 0;
                this.currentBacklog = 0;
                this.currentDailyRevenue = 0;
                this.currentMonthlyRevenue = 0;
                this.target = 50;
                this.callsTarget = 20;
                this.backlogTarget = 0;
                this.dailyRevenueTarget = 5000;
                this.monthlyRevenueTarget = 50000;
                this.shiftStart = '09:00';
                this.shiftEnd = '17:00';
                this.isEndTimeLocked = true;
                
                this.purchaseGoalManager = new PurchaseGoalManager();
                
                this.loadData();
                this.setupEventListeners();
                this.updateDisplay();
                this.startUpdateLoop();
            }

            loadData() {
                const data = localStorage.getItem('activityTracker');
                if (data) {
                    const parsed = JSON.parse(data);
                    const today = new Date().toDateString();
                    const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                    
                    if (parsed.date === today) {
                        this.currentPoints = parsed.currentPoints || 0;
                        this.currentCalls = parsed.currentCalls || 0;
                        this.currentBacklog = parsed.currentBacklog || 0;
                        this.currentDailyRevenue = parsed.currentDailyRevenue || 0;
                        this.target = parsed.target || 50;
                        this.callsTarget = parsed.callsTarget || 20;
                        this.backlogTarget = parsed.backlogTarget || 0;
                        this.dailyRevenueTarget = parsed.dailyRevenueTarget || 5000;
                        this.shiftStart = parsed.shiftStart || '09:00';
                        this.shiftEnd = parsed.shiftEnd || '17:00';
                    }
                    
                    // Monthly revenue persists across days within the same month
                    if (parsed.month === currentMonth) {
                        this.currentMonthlyRevenue = parsed.currentMonthlyRevenue || 0;
                        this.monthlyRevenueTarget = parsed.monthlyRevenueTarget || 50000;
                    }
                }
            }

            saveData() {
                const data = {
                    date: new Date().toDateString(),
                    month: new Date().toISOString().slice(0, 7),
                    currentPoints: this.currentPoints,
                    currentCalls: this.currentCalls,
                    currentBacklog: this.currentBacklog,
                    currentDailyRevenue: this.currentDailyRevenue,
                    currentMonthlyRevenue: this.currentMonthlyRevenue,
                    target: this.target,
                    callsTarget: this.callsTarget,
                    backlogTarget: this.backlogTarget,
                    dailyRevenueTarget: this.dailyRevenueTarget,
                    monthlyRevenueTarget: this.monthlyRevenueTarget,
                    shiftStart: this.shiftStart,
                    shiftEnd: this.shiftEnd
                };
                localStorage.setItem('activityTracker', JSON.stringify(data));
            }

            setupEventListeners() {
                // Click any progress bar to update all metrics
                const activityBar = document.getElementById('activityBar');
                const callsBar = document.getElementById('callsBar');
                const backlogBar = document.getElementById('backlogBar');
                const dailyRevenueBar = document.getElementById('dailyRevenueBar');
                const monthlyRevenueBar = document.getElementById('monthlyRevenueBar');
                
                const bars = [activityBar, callsBar, backlogBar, dailyRevenueBar, monthlyRevenueBar];
                
                bars.forEach(bar => {
                    if (bar) {
                        bar.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.openCombinedDialog();
                        });
                    }
                });

                // Right click
                document.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showContextMenu(e.clientX, e.clientY);
                });

                // Click elsewhere to close menus
                document.addEventListener('click', () => {
                    this.hideContextMenu();
                    this.closeDialog();
                });
            }

            openCombinedDialog() {
                const dialog = document.getElementById('combinedDialog');
                const activityInput = document.getElementById('activityInput');
                const callsInput = document.getElementById('callsInput');
                const backlogInput = document.getElementById('backlogInput');
                const dailyRevenueInput = document.getElementById('dailyRevenueInput');
                const monthlyRevenueInput = document.getElementById('monthlyRevenueInput');
                
                activityInput.value = this.currentPoints;
                callsInput.value = this.currentCalls;
                backlogInput.value = this.currentBacklog;
                dailyRevenueInput.value = this.currentDailyRevenue;
                monthlyRevenueInput.value = this.currentMonthlyRevenue;
                dialog.style.display = 'block';
                activityInput.focus();
                activityInput.select();
                
                // Tab navigation between inputs
                activityInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        callsInput.focus();
                        callsInput.select();
                    } else if (e.key === 'Enter') {
                        saveCombined();
                    }
                });
                
                callsInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab' && e.shiftKey) {
                        e.preventDefault();
                        activityInput.focus();
                        activityInput.select();
                    } else if (e.key === 'Tab') {
                        e.preventDefault();
                        backlogInput.focus();
                        backlogInput.select();
                    } else if (e.key === 'Enter') {
                        saveCombined();
                    }
                });
                
                backlogInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab' && e.shiftKey) {
                        e.preventDefault();
                        callsInput.focus();
                        callsInput.select();
                    } else if (e.key === 'Tab') {
                        e.preventDefault();
                        activityInput.focus();
                        activityInput.select();
                    } else if (e.key === 'Enter') {
                        saveCombined();
                    }
                });
            }

            showContextMenu(x, y) {
                const menu = document.getElementById('contextMenu');
                menu.style.left = x + 'px';
                menu.style.top = y + 'px';
                menu.style.display = 'block';
            }

            hideContextMenu() {
                document.getElementById('contextMenu').style.display = 'none';
            }

            updateDisplay() {
                const now = new Date();
                const [shiftStartHour, shiftStartMin] = this.shiftStart.split(':').map(Number);
                const [shiftEndHour, shiftEndMin] = this.shiftEnd.split(':').map(Number);
                
                const shiftStartTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), shiftStartHour, shiftStartMin);
                const shiftEndTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), shiftEndHour, shiftEndMin);
                
                // Handle overnight shifts
                if (shiftEndTime <= shiftStartTime) {
                    shiftEndTime.setDate(shiftEndTime.getDate() + 1);
                }
                
                const shiftDuration = shiftEndTime - shiftStartTime;
                const elapsedTime = Math.max(0, Math.min(now - shiftStartTime, shiftDuration));
                const timeProgress = elapsedTime / shiftDuration;
                
                // Update time markers
                this.updateTimeMarkers();
                
                // Update all expected lines (daily time-based)
                const expectedLine1 = document.getElementById('expectedLine1');
                const expectedLine2 = document.getElementById('expectedLine2');
                const expectedLine3 = document.getElementById('expectedLine3');
                const expectedLine4 = document.getElementById('expectedLine4');
                if (expectedLine1) expectedLine1.style.left = (timeProgress * 100) + '%';
                if (expectedLine2) expectedLine2.style.left = (timeProgress * 100) + '%';
                if (expectedLine3) expectedLine3.style.left = (timeProgress * 100) + '%';
                if (expectedLine4) expectedLine4.style.left = (timeProgress * 100) + '%';
                
                // Monthly time indicator (based on day of month)
                const currentDay = now.getDate();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const monthProgress = (currentDay - 1) / (daysInMonth - 1); // 0-1 scale
                const expectedLine5 = document.getElementById('expectedLine5');
                if (expectedLine5) expectedLine5.style.left = (monthProgress * 100) + '%';
                
                // Update activity progress
                const activityProgress = this.currentPoints / this.target;
                const activityFill = document.getElementById('activityFill');
                if (activityFill) {
                    activityFill.style.width = Math.max(0.5, activityProgress * 100) + '%';
                    
                    // Color coding for activity
                    const expectedPoints = timeProgress * this.target;
                    const activityRatio = this.currentPoints / expectedPoints;
                    const activityCompletionRatio = this.currentPoints / this.target;
                    
                    activityFill.className = 'activity-fill';
                    if (activityCompletionRatio >= 1.0) {
                        activityFill.classList.add('complete'); // Gold for 100%+ completion
                    } else if (activityRatio >= 1.0) {
                        activityFill.classList.add('ahead');
                    } else if (activityRatio >= 0.9) {
                        activityFill.classList.add('close');
                    } else {
                        activityFill.classList.add('behind');
                    }
                }
                
                // Update calls progress
                const callsProgress = this.currentCalls / this.callsTarget;
                const callsFill = document.getElementById('callsFill');
                if (callsFill) {
                    callsFill.style.width = Math.max(0.5, callsProgress * 100) + '%';
                    
                    // Color coding for calls
                    const expectedCalls = timeProgress * this.callsTarget;
                    const callsRatio = this.currentCalls / expectedCalls;
                    const callsCompletionRatio = this.currentCalls / this.callsTarget;
                    
                    callsFill.className = 'activity-fill';
                    if (callsCompletionRatio >= 1.0) {
                        callsFill.classList.add('complete'); // Gold for 100%+ completion
                    } else if (callsRatio >= 1.0) {
                        callsFill.classList.add('ahead');
                    } else if (callsRatio >= 0.9) {
                        callsFill.classList.add('close');
                    } else {
                        callsFill.classList.add('behind');
                    }
                }
                
                // Update backlog progress (countdown logic)
                const backlogFill = document.getElementById('backlogFill');
                if (this.backlogTarget > 0) {
                    // For countdown: progress = (target - current) / target
                    const backlogProgress = Math.max(0, (this.backlogTarget - this.currentBacklog) / this.backlogTarget);
                    
                    if (backlogFill) {
                        backlogFill.style.width = Math.max(0.5, backlogProgress * 100) + '%';
                        
                        // Color coding for backlog based on expected progress
                        const expectedBacklogRemaining = (1 - timeProgress) * this.backlogTarget;
                        const backlogRatio = (this.backlogTarget - this.currentBacklog) / (this.backlogTarget - expectedBacklogRemaining);
                        
                        backlogFill.className = 'activity-fill';
                        if (this.currentBacklog === 0 && this.backlogTarget > 0) {
                            backlogFill.classList.add('complete'); // Gold when backlog is cleared (0 remaining)
                        } else if (backlogRatio >= 1.0) {
                            backlogFill.classList.add('ahead');
                        } else if (backlogRatio >= 0.9) {
                            backlogFill.classList.add('close');
                        } else {
                            backlogFill.classList.add('behind');
                        }
                    }
                } else {
                    // If no backlog target set, hide the progress bar
                    if (backlogFill) {
                        backlogFill.style.width = '0%';
                        backlogFill.className = 'activity-fill';
                    }
                }
                
                // Update daily revenue progress
                const dailyRevenueProgress = this.currentDailyRevenue / this.dailyRevenueTarget;
                const dailyRevenueFill = document.getElementById('dailyRevenueFill');
                if (dailyRevenueFill) {
                    dailyRevenueFill.style.width = Math.max(0.5, dailyRevenueProgress * 100) + '%';
                    
                    // Color coding for daily revenue
                    const expectedDailyRevenue = timeProgress * this.dailyRevenueTarget;
                    const dailyRevenueRatio = this.currentDailyRevenue / expectedDailyRevenue;
                    const dailyRevenueCompletionRatio = this.currentDailyRevenue / this.dailyRevenueTarget;
                    
                    dailyRevenueFill.className = 'activity-fill';
                    if (dailyRevenueCompletionRatio >= 1.0) {
                        dailyRevenueFill.classList.add('complete');
                    } else if (dailyRevenueRatio >= 1.0) {
                        dailyRevenueFill.classList.add('ahead');
                    } else if (dailyRevenueRatio >= 0.9) {
                        dailyRevenueFill.classList.add('close');
                    } else {
                        dailyRevenueFill.classList.add('behind');
                    }
                }
                
                // Update monthly revenue progress
                const monthlyRevenueProgress = this.currentMonthlyRevenue / this.monthlyRevenueTarget;
                const monthlyRevenueFill = document.getElementById('monthlyRevenueFill');
                if (monthlyRevenueFill) {
                    monthlyRevenueFill.style.width = Math.max(0.5, monthlyRevenueProgress * 100) + '%';
                    
                    // Color coding for monthly revenue based on month progress
                    const expectedMonthlyRevenue = monthProgress * this.monthlyRevenueTarget;
                    const monthlyRevenueRatio = this.currentMonthlyRevenue / expectedMonthlyRevenue;
                    const monthlyRevenueCompletionRatio = this.currentMonthlyRevenue / this.monthlyRevenueTarget;
                    
                    monthlyRevenueFill.className = 'activity-fill';
                    if (monthlyRevenueCompletionRatio >= 1.0) {
                        monthlyRevenueFill.classList.add('complete');
                    } else if (monthlyRevenueRatio >= 1.0) {
                        monthlyRevenueFill.classList.add('ahead');
                    } else if (monthlyRevenueRatio >= 0.9) {
                        monthlyRevenueFill.classList.add('close');
                    } else {
                        monthlyRevenueFill.classList.add('behind');
                    }
                }
                
                // Update displays
                const activityDisplay = document.getElementById('activityDisplay');
                const callsDisplay = document.getElementById('callsDisplay');
                const backlogDisplay = document.getElementById('backlogDisplay');
                const dailyRevenueDisplay = document.getElementById('dailyRevenueDisplay');
                const monthlyRevenueDisplay = document.getElementById('monthlyRevenueDisplay');
                
                if (activityDisplay) activityDisplay.textContent = `${this.currentPoints}/${this.target}`;
                if (callsDisplay) callsDisplay.textContent = `${this.currentCalls}/${this.callsTarget}`;
                if (backlogDisplay) backlogDisplay.textContent = `${this.currentBacklog}/${this.backlogTarget}`;
                if (dailyRevenueDisplay) dailyRevenueDisplay.textContent = `$${(this.currentDailyRevenue/1000).toFixed(1)}K`;
                if (monthlyRevenueDisplay) monthlyRevenueDisplay.textContent = `$${(this.currentMonthlyRevenue/1000).toFixed(1)}K`;
            }

            updateTimeMarkers() {
                const [startHour] = this.shiftStart.split(':').map(Number);
                const [endHour] = this.shiftEnd.split(':').map(Number);
                
                const markers = document.querySelectorAll('.time-marker');
                markers.forEach((marker, index) => {
                    const hour = startHour + index;
                    const displayHour = hour > 24 ? hour - 24 : hour;
                    marker.textContent = displayHour.toString().padStart(2, '0');
                    marker.style.left = (index / (markers.length - 1) * 100) + '%';
                });
            }

            startUpdateLoop() {
                this.updateDisplay();
                setInterval(() => this.updateDisplay(), 5 * 60 * 1000); // 5 minutes
            }
        }

        let tracker;
        let isEndTimeLocked = true;

        // Initialize when page loads
        window.addEventListener('load', () => {
            tracker = new ActivityTracker();
        });

        // Revenue Goals Management Functions
        function openRevenueGoals() {
            const panel = document.getElementById('revenueGoalsPanel');
            
            // Load current commission settings
            document.getElementById('commissionRate').value = tracker.purchaseGoalManager.calculator.commissionRate;
            document.getElementById('taxRate').value = tracker.purchaseGoalManager.calculator.taxRate;
            
            // Populate goals list
            populatePurchaseGoalsList();
            updateRevenuePathVisualization();
            
            panel.style.display = 'block';
        }

        function closeRevenueGoals() {
            document.getElementById('revenueGoalsPanel').style.display = 'none';
        }

        function addPurchaseGoal() {
            const nameInput = document.getElementById('newGoalName');
            const costInput = document.getElementById('newGoalCost');
            
            const name = nameInput.value.trim();
            const cost = parseFloat(costInput.value);
            
            if (!name) {
                alert('Please enter an item name');
                return;
            }
            
            if (!cost || cost <= 0) {
                alert('Please enter a valid cost');
                return;
            }
            
            tracker.purchaseGoalManager.addGoal(name, cost);
            
            // Clear inputs
            nameInput.value = '';
            costInput.value = '';
            
            // Refresh display
            populatePurchaseGoalsList();
            updateRevenuePathVisualization();
        }

        function populatePurchaseGoalsList() {
            const container = document.getElementById('purchaseGoalsList');
            const goals = tracker.purchaseGoalManager.getGoalsSorted();
            
            if (goals.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No purchase goals yet. Add one above!</div>';
                return;
            }
            
            container.innerHTML = goals.map((goal, index) => `
                <div class="goal-item" draggable="${!goal.purchased}" data-goal-id="${goal.id}" 
                     style="display: flex; align-items: center; padding: 6px; border: 1px solid #ddd; margin-bottom: 4px; background: ${goal.purchased ? '#f0f8f0' : 'white'}; border-radius: 3px; cursor: ${!goal.purchased ? 'move' : 'default'};">
                    
                    ${!goal.purchased ? '<div class="drag-handle" style="margin-right: 6px; color: #999; cursor: grab;">⋮⋮</div>' : ''}
                    
                    <input type="checkbox" ${goal.purchased ? 'checked' : ''} 
                           onchange="toggleGoalPurchased('${goal.id}')"
                           style="margin-right: 6px;">
                    
                    <div style="flex: 1; font-weight: 500; ${goal.purchased ? 'text-decoration: line-through; color: #666;' : ''}">${goal.name}</div>
                    
                    <div style="font-size: 11px; color: #666; margin-right: 8px;">$${goal.cost}</div>
                    
                    <div style="font-size: 10px; color: #888; margin-right: 8px;">→ $${(goal.requiredRevenue/1000).toFixed(1)}K rev</div>
                    
                    <button onclick="removeGoal('${goal.id}')" 
                            style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 10px; cursor: pointer;">×</button>
                </div>
            `).join('');
            
            // Add drag and drop functionality
            setupDragAndDrop();
        }

        function setupDragAndDrop() {
            const goalItems = document.querySelectorAll('.goal-item[draggable="true"]');
            
            goalItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.style.opacity = '0.5';
        }

        function handleDragOver(e) {
            e.preventDefault();
            this.style.borderTop = '2px solid #007acc';
        }

        function handleDrop(e) {
            e.preventDefault();
            this.style.borderTop = '';
            
            if (draggedElement !== this) {
                const draggedId = draggedElement.dataset.goalId;
                const targetId = this.dataset.goalId;
                
                const goals = tracker.purchaseGoalManager.goals;
                const draggedIndex = goals.findIndex(g => g.id === draggedId);
                const targetIndex = goals.findIndex(g => g.id === targetId);
                
                if (draggedIndex !== -1 && targetIndex !== -1) {
                    tracker.purchaseGoalManager.moveGoal(draggedIndex, targetIndex);
                    populatePurchaseGoalsList();
                    updateRevenuePathVisualization();
                }
            }
        }

        function handleDragEnd(e) {
            this.style.opacity = '';
            document.querySelectorAll('.goal-item').forEach(item => {
                item.style.borderTop = '';
            });
        }

        function toggleGoalPurchased(goalId) {
            const goal = tracker.purchaseGoalManager.goals.find(g => g.id === goalId);
            if (goal) {
                tracker.purchaseGoalManager.updateGoal(goalId, { purchased: !goal.purchased });
                populatePurchaseGoalsList();
                updateRevenuePathVisualization();
            }
        }

        function removeGoal(goalId) {
            if (confirm('Remove this purchase goal?')) {
                tracker.purchaseGoalManager.removeGoal(goalId);
                populatePurchaseGoalsList();
                updateRevenuePathVisualization();
            }
        }

        function updateCommissionSettings() {
            const commissionRate = parseFloat(document.getElementById('commissionRate').value) || 0.0025;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0.325;
            
            tracker.purchaseGoalManager.calculator = new RevenueCalculator(commissionRate, taxRate);
            
            // Recalculate all required revenues
            tracker.purchaseGoalManager.goals.forEach(goal => {
                goal.requiredRevenue = Math.round(tracker.purchaseGoalManager.calculator.calculateRevenueForPurchase(goal.cost));
            });
            tracker.purchaseGoalManager.save();
            
            // Refresh displays
            populatePurchaseGoalsList();
            updateRevenuePathVisualization();
            
            alert('Commission settings updated!');
        }

        function updateRevenuePathVisualization() {
            const pathContainer = document.getElementById('revenuePath');
            const labelsContainer = document.getElementById('revenuePathLabels');
            
            const currentRevenue = tracker.currentMonthlyRevenue;
            const goals = tracker.purchaseGoalManager.calculateProgress(currentRevenue);
            
            if (goals.length === 0) {
                pathContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">No goals to visualize</div>';
                labelsContainer.innerHTML = '';
                return;
            }
            
            const totalRevenue = goals.reduce((sum, goal) => sum + goal.requiredRevenue, 0);
            let cumulativeRevenue = 0;
            
            // Create progress segments
            const segments = goals.map(goal => {
                const startPercent = (cumulativeRevenue / totalRevenue) * 100;
                const widthPercent = (goal.requiredRevenue / totalRevenue) * 100;
                cumulativeRevenue += goal.requiredRevenue;
                
                const color = goal.purchased ? '#28a745' : 
                             goal.achieved ? '#ffd700' : 
                             goal.progress > 0 ? `linear-gradient(to right, #007acc ${goal.progress * 100}%, #e0e0e0 ${goal.progress * 100}%)` : '#e0e0e0';
                
                return {
                    goal,
                    startPercent,
                    widthPercent,
                    color
                };
            });
            
            // Render segments
            pathContainer.innerHTML = segments.map(segment => `
                <div style="position: absolute; left: ${segment.startPercent}%; width: ${segment.widthPercent}%; height: 100%; background: ${segment.color}; border-right: 1px solid #999;" title="${segment.goal.name}: $${segment.goal.cost} (${(segment.goal.progress * 100).toFixed(1)}% complete)"></div>
            `).join('') + 
            `<div style="position: absolute; left: ${(currentRevenue / totalRevenue) * 100}%; width: 2px; height: 100%; background: red; z-index: 10;" title="Current Revenue: $${currentRevenue}"></div>`;
            
            // Render labels
            labelsContainer.innerHTML = segments.map(segment => `
                <span style="display: inline-block; margin-right: 12px; font-size: 10px;">
                    <span style="display: inline-block; width: 12px; height: 12px; background: ${segment.goal.purchased ? '#28a745' : segment.goal.achieved ? '#ffd700' : '#007acc'}; border-radius: 2px; margin-right: 4px; vertical-align: middle;"></span>
                    ${segment.goal.name} ($${(segment.goal.requiredRevenue/1000).toFixed(1)}K)
                    ${segment.goal.purchased ? '✓' : segment.goal.achieved ? '★' : ''}
                </span>
            `).join('');
        }

        function saveCombined() {
            const activityInput = document.getElementById('activityInput');
            const callsInput = document.getElementById('callsInput');
            const backlogInput = document.getElementById('backlogInput');
            const dailyRevenueInput = document.getElementById('dailyRevenueInput');
            const monthlyRevenueInput = document.getElementById('monthlyRevenueInput');
            
            const points = parseInt(activityInput.value) || 0;
            const calls = parseInt(callsInput.value) || 0;
            const backlog = parseInt(backlogInput.value) || 0;
            const dailyRevenue = parseInt(dailyRevenueInput.value) || 0;
            const monthlyRevenue = parseInt(monthlyRevenueInput.value) || 0;
            
            tracker.currentPoints = points;
            tracker.currentCalls = calls;
            tracker.currentBacklog = backlog;
            tracker.currentDailyRevenue = dailyRevenue;
            tracker.currentMonthlyRevenue = monthlyRevenue;
            tracker.saveData();
            tracker.updateDisplay();
            closeDialog();
        }

        function closeDialog() {
            document.getElementById('combinedDialog').style.display = 'none';
        }

        function openSettings() {
            document.getElementById('startTimeInput').value = tracker.shiftStart;
            document.getElementById('endTimeInput').value = tracker.shiftEnd;
            document.getElementById('targetInput').value = tracker.target;
            document.getElementById('callsTargetInput').value = tracker.callsTarget;
            document.getElementById('backlogTargetInput').value = tracker.backlogTarget;
            document.getElementById('dailyRevenueTargetInput').value = tracker.dailyRevenueTarget;
            document.getElementById('monthlyRevenueTargetInput').value = tracker.monthlyRevenueTarget;
            document.getElementById('settingsPanel').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsPanel').style.display = 'none';
        }

        function saveSettings() {
            tracker.shiftStart = document.getElementById('startTimeInput').value;
            tracker.shiftEnd = document.getElementById('endTimeInput').value;
            tracker.target = parseInt(document.getElementById('targetInput').value) || 50;
            tracker.callsTarget = parseInt(document.getElementById('callsTargetInput').value) || 20;
            tracker.backlogTarget = parseInt(document.getElementById('backlogTargetInput').value) || 0;
            tracker.dailyRevenueTarget = parseInt(document.getElementById('dailyRevenueTargetInput').value) || 5000;
            tracker.monthlyRevenueTarget = parseInt(document.getElementById('monthlyRevenueTargetInput').value) || 50000;
            tracker.saveData();
            tracker.updateDisplay();
            closeSettings();
        }

        function toggleEndTimeLock() {
            const startTimeInput = document.getElementById('startTimeInput');
            const endTimeInput = document.getElementById('endTimeInput');
            const lockButton = document.getElementById('lockButton');
            
            isEndTimeLocked = !isEndTimeLocked;
            
            if (isEndTimeLocked) {
                endTimeInput.readOnly = true;
                endTimeInput.style.background = '#f8f8f8';
                lockButton.textContent = '🔒';
                updateEndTime();
            } else {
                endTimeInput.readOnly = false;
                endTimeInput.style.background = 'white';
                lockButton.textContent = '🔓';
            }
        }

        function updateEndTime() {
            if (isEndTimeLocked) {
                const startTime = document.getElementById('startTimeInput').value;
                if (startTime) {
                    const [hours, minutes] = startTime.split(':').map(Number);
                    const endHours = (hours + 8) % 24;
                    const endTime = endHours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0');
                    document.getElementById('endTimeInput').value = endTime;
                }
            }
        }

        // Update end time when start time changes (if locked)
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('startTimeInput').addEventListener('change', updateEndTime);
        });
    </script>
</body>
</html>