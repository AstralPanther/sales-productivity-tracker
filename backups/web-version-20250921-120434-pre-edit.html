<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Points Tracker</title>
    <style>
        /* CSS Custom Properties for Light/Dark Mode */
        :root {
            /* Light mode colors (default) */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f0f8ff;
            --bg-accent: #f8f8f8;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #888888;
            --border-color: #ddd;
            --border-light: #eee;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-strong: rgba(0, 0, 0, 0.3);
            --overlay-bg: rgba(0, 0, 0, 0.5);
            --input-bg: #ffffff;
            --button-secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --primary: #007acc;
            --primary-light: #4dc3ff;
            --progress-bg: #e0e0e0;
        }

        /* Dark mode colors */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2d2d2d;
                --bg-tertiary: #1e2a3a;
                --bg-accent: #2a2a2a;
                --text-primary: #e0e0e0;
                --text-secondary: #b0b0b0;
                --text-muted: #808080;
                --border-color: #444;
                --border-light: #333;
                --shadow: rgba(0, 0, 0, 0.3);
                --shadow-strong: rgba(0, 0, 0, 0.6);
                --overlay-bg: rgba(0, 0, 0, 0.8);
                --input-bg: #2a2a2a;
                --button-secondary: #6c757d;
                --success: #28a745;
                --danger: #dc3545;
                --primary: #0099ff;
                --primary-light: #66b3ff;
                --progress-bg: #3a3a3a;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: clamp(9px, 2.5vw, 12px);
            background: var(--bg-secondary);
            color: var(--text-primary);
            user-select: none;
            width: 400px;
            margin: 20px;
            resize: both;
            min-width: 300px;
            min-height: 140px;
        }

        .app-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tracker-container {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            height: 125px;
            background: var(--bg-primary);
        }

        .menu-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            align-self: center;
            transition: background-color 0.3s;
        }

        .menu-button:hover {
            background: var(--primary-light);
        }

        /* Menu System */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .menu-overlay.active {
            display: flex;
        }

        .menu-container {
            background: var(--bg-primary);
            border-radius: 8px;
            box-shadow: 0 4px 20px var(--shadow-strong);
            border: 1px solid var(--border-color);
            width: 95%;
            max-width: 1200px;
            max-height: 95vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .menu-tabs {
            display: flex;
            background: var(--bg-accent);
            border-bottom: 1px solid var(--border-color);
        }

        .menu-tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            background: var(--bg-accent);
            color: var(--text-secondary);
            cursor: pointer;
            border: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .menu-tab:hover {
            background: var(--bg-secondary);
        }

        .menu-tab.active {
            background: var(--bg-primary);
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .menu-content {
            flex: 1;
            overflow: hidden;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .menu-page {
            display: none;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .menu-page.active {
            display: flex;
            flex-direction: column;
        }

        .menu-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            z-index: 10;
        }

        .menu-close:hover {
            color: var(--text-secondary);
        }

        .tracker-container {
            width: 100%;
            height: 125px;
            padding: 1px 2vw 0px 2vw;
            position: relative;
            overflow: hidden;
        }

        .progress-bar-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: space-between;
            padding: 1px 0 0 0;
            gap: 1px;
        }

        .time-markers {
            position: relative;
            height: 12px;
            margin-bottom: 1px;
        }

        .time-marker {
            position: absolute;
            font-size: clamp(8px, 2vw, 11px);
            color: var(--text-secondary);
            font-weight: 500;
            text-align: center;
            min-width: 20px;
            transform: translateX(-50%);
        }

        .progress-bar {
            flex: 1;
            position: relative;
            background: var(--progress-bg);
            border-radius: 3px;
            height: clamp(16px, 15vh, 28px);
            overflow: visible;
            cursor: pointer;
            min-height: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: stretch;
            margin: 0;
        }

        .bar-label {
            position: absolute;
            left: 6px;
            top: 50%;
            transform: translateY(-50%);
            font-size: clamp(8px, 2vw, 11px);
            color: #555;
            font-weight: 500;
            z-index: 5;
            pointer-events: none;
        }

        .activity-fill {
            height: 100% !important;
            min-height: 10px;
            border-radius: 3px;
            transition: width 0.3s ease, background-color 0.3s ease;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            background: #ccc;
            min-width: 2px;
            display: block !important;
            box-sizing: border-box;
        }

        .activity-fill.behind {
            background: linear-gradient(90deg, #ff4444, #ff6666);
        }

        .activity-fill.close {
            background: linear-gradient(90deg, #ffaa00, #ffcc44);
        }

        .activity-fill.ahead {
            background: linear-gradient(90deg, #44aa44, #66cc66);
        }

        .activity-fill.complete {
            background: linear-gradient(90deg, #ffd700, #ffed4e);
        }
        
        /* Multiplier display for overflowing progress bars */
        .activity-fill[data-multiplier]::after {
            content: attr(data-multiplier);
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.7);
            background: rgba(255, 255, 255, 0.8);
            padding: 1px 4px;
            border-radius: 2px;
        }

        .expected-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #ffff00, #ff8800);
            border-left: 1px solid rgba(0,0,0,0.3);
            border-right: 1px solid rgba(0,0,0,0.3);
            z-index: 10;
            transition: left 0.3s ease;
            box-shadow: 0 0 3px rgba(255, 136, 0, 0.6);
        }

        .points-display {
            position: absolute;
            top: 50%;
            right: 6px;
            transform: translateY(-50%);
            font-weight: bold;
            font-size: clamp(8px, 2vw, 12px);
            color: var(--text-primary);
            z-index: 15;
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
            pointer-events: none;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 2000;
            min-width: 120px;
            display: none;
        }

        .menu-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 11px;
            transition: background-color 0.2s;
        }

        .menu-item:hover {
            background: var(--bg-secondary);
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 80px;
            left: 20px;
            background: var(--bg-primary);
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 350px;
            display: none;
        }

        .settings-panel h3 {
            margin-bottom: 12px;
            font-size: 13px;
            color: var(--text-primary);
        }

        .setting-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .setting-row label {
            font-size: 11px;
            color: #555;
            min-width: 50px;
        }

        .setting-row input {
            padding: 4px 6px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 11px;
            flex: 1;
        }

        .setting-buttons {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        .setting-buttons button {
            flex: 1;
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            background: var(--bg-primary);
            transition: background-color 0.2s;
        }

        .setting-buttons button:hover {
            background: var(--bg-secondary);
        }

        #saveSettings {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        #saveSettings:hover {
            background: var(--primary-light);
        }

        .dialog {
            position: fixed;
            top: 80px;
            left: 20px;
            background: var(--bg-primary);
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none;
        }

        .dialog-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .dialog-row label {
            font-size: 11px;
            color: var(--text-primary);
        }

        .dialog-row input {
            padding: 4px 6px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 11px;
            width: 60px;
        }

        .dialog-row button {
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            background: var(--bg-primary);
        }
        
        /* Milestone Icons on Progress Bars */
        .milestone-icon {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(14px, 3vw, 18px);
            z-index: 10;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease;
            line-height: 1;
        }
        
        .milestone-icon:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        .milestone-icon.pending {
            filter: grayscale(50%) opacity(0.7);
        }
        
        .milestone-icon.in-progress {
            filter: brightness(1.1);
            animation: pulse 2s infinite;
        }
        
        .milestone-icon.achieved {
            filter: brightness(1.2) drop-shadow(0 0 4px gold);
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }
        
        /* Icon Picker Styles */
        #iconPicker span:hover {
            background: var(--bg-secondary);
            transform: scale(1.1);
        }
        
        /* Future Goals Indicator */
        .future-goals-indicator {
            position: relative;
        }
        
        .future-goals-indicator:hover .future-goals-preview {
            opacity: 1;
            transform: scale(1.05);
        }
        
        /* Remove spinner arrows from revenue inputs */
        input[id*="Revenue"]::-webkit-outer-spin-button,
        input[id*="Revenue"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[id*="Revenue"][type=number] {
            -moz-appearance: textfield;
        }
        
        /* Force 24h time format */
        input[type="time"] {
            -webkit-locale: "en-GB";
        }
        input[type="time"]::-webkit-datetime-edit-fields-wrapper {
            display: flex;
        }
        input[type="time"]::-webkit-datetime-edit-ampm-field {
            display: none;
        }

        /* Input and form element styling for dark mode */
        input, button, select, textarea {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        input:focus, button:focus, select:focus, textarea:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Ensure proper contrast for all text elements */
        .bar-label, .points-display {
            color: var(--text-primary);
            text-shadow: 1px 1px 2px var(--shadow);
        }

        /* Menu close button styling */
        .menu-close {
            background: var(--danger);
            color: white;
            border: none;
        }

        .menu-close:hover {
            background: #c82333;
        }

        /* Progress indicators styling */
        .time-marker {
            color: var(--text-muted);
        }

        /* Icon picker styling */
        #iconPicker {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px var(--shadow);
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <!-- Main Tracker (Original Layout) -->
        <div class="tracker-container">
            <div class="progress-bar-container">
                <div class="time-markers">
                    <span class="time-marker" data-hour="09">09</span>
                    <span class="time-marker" data-hour="10">10</span>
                    <span class="time-marker" data-hour="11">11</span>
                    <span class="time-marker" data-hour="12">12</span>
                    <span class="time-marker" data-hour="13">13</span>
                    <span class="time-marker" data-hour="14">14</span>
                    <span class="time-marker" data-hour="15">15</span>
                    <span class="time-marker" data-hour="16">16</span>
                    <span class="time-marker" data-hour="17">17</span>
                </div>
                
                <div class="progress-bar" id="activityBar">
                    <div class="activity-fill" id="activityFill"></div>
                    <div class="expected-line" id="expectedLine1"></div>
                    <div class="bar-label">Activity</div>
                    <div class="points-display" id="activityDisplay">0/50</div>
                </div>
                
                <div class="progress-bar" id="callsBar">
                    <div class="activity-fill" id="callsFill"></div>
                    <div class="expected-line" id="expectedLine2"></div>
                    <div class="bar-label">Outbound Calls</div>
                    <div class="points-display" id="callsDisplay">0/20</div>
                </div>
                
                <div class="progress-bar" id="backlogBar">
                    <div class="activity-fill" id="backlogFill"></div>
                    <div class="expected-line" id="expectedLine3"></div>
                    <div class="bar-label">Today's Tasks</div>
                    <div class="points-display" id="backlogDisplay">0/0</div>
                </div>
                
                <div class="progress-bar" id="dailyRevenueBar">
                    <div class="activity-fill" id="dailyRevenueFill"></div>
                    <div class="expected-line" id="expectedLine4"></div>
                    <div class="bar-label">Daily Revenue</div>
                    <div class="points-display" id="dailyRevenueDisplay">$0</div>
                </div>
                
                <div class="progress-bar" id="monthlyRevenueBar">
                    <div class="activity-fill" id="monthlyRevenueFill"></div>
                    <div class="expected-line" id="expectedLine5"></div>
                    <div class="bar-label">Monthly Revenue</div>
                    <div class="points-display" id="monthlyRevenueDisplay">$0</div>
                </div>
            </div>
        </div>

        <!-- Menu Button -->
        <button class="menu-button" onclick="openMenu()">‚öôÔ∏è Open Menu</button>
    </div>

    <!-- Menu System -->
    <div class="menu-overlay" id="menuOverlay">
        <div class="menu-container">
            <button class="menu-close" onclick="closeMenu()">√ó</button>
            
            <!-- Menu Tabs -->
            <div class="menu-tabs">
                <button class="menu-tab active" onclick="showMenuPage('update')">üìù Update & Settings</button>
                <button class="menu-tab" onclick="showMenuPage('goals')">üéØ Purchase Goals</button>
            </div>
            
            <!-- Menu Content -->
            <div class="menu-content">
                <!-- Update Progress & Settings Page -->
                <div id="updatePage" class="menu-page active">
                    <h3 style="margin: 0 0 20px 0; text-align: center; color: var(--text-primary);">Update Progress & Settings</h3>
                    <div id="updatePageContent">
                        <!-- Update form and settings will be populated here -->
                    </div>
                </div>
                
                <!-- Purchase Goals Page -->
                <div id="goalsPage" class="menu-page">
                    <h3 style="margin: 0 0 20px 0; text-align: center; color: var(--text-primary);">Purchase Goals & Revenue Planning</h3>
                    <div id="goalsPageContent">
                        <!-- Goals content will be moved here -->
                    </div>
                </div>
            </div>
        </div>
    </div>




    <!-- Icon Picker Popup -->
    <div id="iconPicker" style="display: none; position: fixed; background: var(--bg-primary); border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 3000; padding: 8px;">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; max-width: 200px;">
            <span onclick="selectIcon('laptop')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="Laptop">üíª</span>
            <span onclick="selectIcon('computer')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="Computer">üñ•Ô∏è</span>
            <span onclick="selectIcon('phone')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="Phone">üì±</span>
            <span onclick="selectIcon('car')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="Car">üöó</span>
            <span onclick="selectIcon('vacation')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="Vacation">‚úàÔ∏è</span>
            <span onclick="selectIcon('house')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="House">üè†</span>
            <span onclick="selectIcon('camera')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="Camera">üì∑</span>
            <span onclick="selectIcon('watch')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="Watch">‚åö</span>
            <span onclick="selectIcon('bike')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="Bike">üö≤</span>
            <span onclick="selectIcon('game')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="Game">üéÆ</span>
            <span onclick="selectIcon('music')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="Music">üéµ</span>
            <span onclick="selectIcon('book')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="Book">üìö</span>
            <span onclick="selectIcon('shoes')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="Shoes">üëü</span>
            <span onclick="selectIcon('keyboard')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="Keyboard">‚å®Ô∏è</span>
            <span onclick="selectIcon('default')" style="padding: 4px; cursor: pointer; border-radius: 3px; text-align: center; font-size: 20px;" title="Other">üéØ</span>
        </div>
    </div>

    <!-- Version Info -->
    <div style="padding: 0 2vw; margin-top: 10px;">
        <div style="display: flex; align-items: center; justify-content: space-between; font-size: 11px; color: var(--text-secondary);">
            <span>Sales Productivity Tracker v1.5.1</span>
            <span onclick="showChangelog()" style="cursor: pointer; text-decoration: underline;" title="Click to see what's new">üìù What's New</span>
        </div>
    </div>

    <!-- Sales History Section -->
    <div id="salesHistorySection" style="margin-top: 15px; padding: 0 2vw;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
            <h3 style="margin: 0; color: var(--text-primary); font-size: 16px;">üìä History</h3>
            <button onclick="addNewSalesEntry()" style="background: var(--success); color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">+ Add Sale</button>
        </div>
        <div id="salesHistoryContent" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary);">
            <!-- Sales history will be populated here -->
        </div>
    </div>

    <script>
        // Menu System Functions
        function openMenu() {
            const menuOverlay = document.getElementById('menuOverlay');
            menuOverlay.classList.add('active');
            
            // Populate update page with current values
            populateUpdatePage();
            
            // Show update page by default
            showMenuPage('update');
        }

        function closeMenu() {
            const menuOverlay = document.getElementById('menuOverlay');
            menuOverlay.classList.remove('active');
        }

        function showMenuPage(pageId) {
            // Hide all menu pages
            document.querySelectorAll('.menu-page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all menu tabs
            document.querySelectorAll('.menu-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId + 'Page').classList.add('active');
            
            // Activate corresponding tab
            const tabButton = document.querySelector(`[onclick="showMenuPage('${pageId}')"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
            
            // Populate content based on page
            if (pageId === 'update') {
                populateUpdatePage();
            } else if (pageId === 'goals') {
                populateGoalsPage();
            }
        }

        function populateUpdatePage() {
            const content = document.getElementById('updatePageContent');
            content.innerHTML = `
                <div style="display: flex; flex-direction: column; height: 100%; padding: 0 10px;">
                    <!-- Progress Update Section -->
                    <div style="background: var(--bg-accent); padding: 12px; border-radius: 4px; margin-bottom: 15px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 16px; color: var(--text-primary);">Update Progress</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px;">
                            <div>
                                <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Activity Points:</label>
                                <input type="number" id="menuActivityInput" min="0" max="200" value="${tracker ? tracker.currentPoints : 0}" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Outbound Calls:</label>
                                <input type="number" id="menuCallsInput" min="0" max="100" value="${tracker ? tracker.currentCalls : 0}" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Completed Tasks:</label>
                                <input type="number" id="menuBacklogInput" min="0" max="1000" value="${tracker ? tracker.currentBacklog : 0}" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Daily Revenue:</label>
                                <input type="number" id="menuDailyRevenueInput" min="0" max="200000" step="100" value="${tracker ? tracker.currentDailyRevenue : 0}" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Monthly Revenue:</label>
                                <input type="number" id="menuMonthlyRevenueInput" min="0" max="2000000" step="1000" value="${tracker ? tracker.getMonthlyRevenueFromHistory() : 0}" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                            </div>
                        </div>
                    </div>

                    <!-- Settings Section -->
                    <div style="flex: 1; display: grid; grid-template-columns: 1fr 2fr; gap: 15px; align-content: start;">
                        <!-- Shift Schedule Section -->
                        <div style="background: var(--bg-accent); padding: 12px; border-radius: 4px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px; color: var(--text-primary);">Shift Schedule</h3>
                            <div style="display: grid; gap: 10px;">
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Start Time:</label>
                                    <input type="time" id="settingsShiftStart" value="${tracker ? tracker.shiftStart : '09:00'}" step="1" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">End Time:</label>
                                    <input type="time" id="settingsShiftEnd" value="${tracker ? tracker.shiftEnd : '17:00'}" step="1" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Daily Targets Section -->
                        <div style="background: var(--bg-accent); padding: 12px; border-radius: 4px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px; color: var(--text-primary);">Daily Targets</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Activity Points:</label>
                                    <input type="number" id="settingsTarget" value="${tracker ? tracker.target : 50}" min="1" max="200" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Outbound Calls:</label>
                                    <input type="number" id="settingsCallsTarget" value="${tracker ? tracker.callsTarget : 20}" min="1" max="100" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Today's Tasks:</label>
                                    <input type="number" id="settingsBacklogTarget" value="${tracker ? tracker.backlogTarget : 0}" min="0" max="1000" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Daily Revenue:</label>
                                    <input type="number" id="settingsDailyRevenueTarget" value="${tracker ? tracker.dailyRevenueTarget : 5000}" min="0" max="100000" step="100" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Monthly Revenue:</label>
                                    <input type="number" id="settingsMonthlyRevenueTarget" value="${tracker ? tracker.monthlyRevenueTarget : 50000}" min="0" max="1000000" step="1000" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 12px 0; text-align: center; border-top: 1px solid var(--border-light); margin-top: 12px;">
                        <button onclick="saveProgressAndSettings()" style="background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 3px; cursor: pointer; font-size: 14px; margin-right: 10px;">Save All</button>
                        <button onclick="resetData()" style="background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 3px; cursor: pointer; font-size: 14px; margin-right: 10px;">Reset All Data</button>
                        <button onclick="closeMenu()" style="background: var(--button-secondary); color: white; border: none; padding: 10px 20px; border-radius: 3px; cursor: pointer; font-size: 14px;">Cancel</button>
                    </div>
                </div>
            `;
        }

        function saveProgress() {
            if (!tracker) return;
            
            const activityInput = document.getElementById('menuActivityInput');
            const callsInput = document.getElementById('menuCallsInput');
            const backlogInput = document.getElementById('menuBacklogInput');
            const dailyRevenueInput = document.getElementById('menuDailyRevenueInput');
            const monthlyRevenueInput = document.getElementById('menuMonthlyRevenueInput');
            
            const points = parseInt(activityInput.value) || 0;
            const calls = parseInt(callsInput.value) || 0;
            const completedTasks = parseInt(backlogInput.value) || 0;
            const dailyRevenue = parseInt(dailyRevenueInput.value) || 0;
            const monthlyRevenue = parseInt(monthlyRevenueInput.value) || 0;
            
            // Update tracker data
            tracker.currentPoints = points;
            tracker.currentCalls = calls;
            tracker.currentBacklog = completedTasks; // Now directly completed tasks
            tracker.currentDailyRevenue = dailyRevenue;
            
            // Sync monthly revenue with sales history
            const currentMonthRevenue = tracker.getMonthlyRevenueFromHistory();
            if (monthlyRevenue !== currentMonthRevenue) {
                tracker.updateCurrentMonthRevenue(monthlyRevenue);
                populateSalesHistory(); // Refresh sales history display
            }
            
            // Record daily progress
            const today = new Date().toISOString().slice(0, 10);
            tracker.addDailyProgressEntry(today, points, calls, completedTasks, dailyRevenue);
            
            // Save to localStorage
            tracker.saveData();
            
            // Update display
            tracker.updateDisplay();
            tracker.updateMonthlyRevenueMilestones();
            
            // Close menu
            closeMenu();
            
            // Show brief success indicator
            showSuccessIndicator('Progress updated!');
        }

        function showSuccessIndicator(message) {
            const indicator = document.createElement('div');
            indicator.innerHTML = message;
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success);
                color: white;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                z-index: 10000;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            `;
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 2000);
        }

        // Add global Esc key support for closing menu and Enter key for saving/closing
        document.addEventListener('keydown', (e) => {
            const menuOverlay = document.getElementById('menuOverlay');
            if (menuOverlay && menuOverlay.classList.contains('active')) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeMenu();
                } else if (e.key === 'Enter' && !e.target.closest('button')) {
                    e.preventDefault();
                    // Check which page is active and call appropriate save function
                    const currentPage = document.querySelector('.menu-tab.active');
                    if (currentPage && currentPage.textContent.includes('Update')) {
                        saveProgressAndSettings();
                    } else if (currentPage && currentPage.textContent.includes('Purchase Goals')) {
                        // Check if we're in the add goal form
                        const activeElement = document.activeElement;
                        if (activeElement && (activeElement.id === 'newGoalName' || activeElement.id === 'newGoalCost')) {
                            // Trigger add goal if we're in the form
                            addPurchaseGoal();
                        } else {
                            // Otherwise close the menu
                            closeMenu();
                        }
                    }
                }
            }
        });

        function populateGoalsPage() {
            const content = document.getElementById('goalsPageContent');
            content.innerHTML = `
                <div style="display: flex; flex-direction: column; height: 100%; padding: 0 10px; align-items: center;">
                    <!-- Commission & Sales Rate Settings -->
                    <div style="background: var(--bg-accent); padding: 10px; border-radius: 4px; margin-bottom: 10px; width: 100%; max-width: 500px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 15px; color: var(--text-primary);">Commission & Rate Settings</h3>
                        <div style="display: flex; gap: 15px; align-items: center; font-size: 13px; flex-wrap: wrap; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="font-weight: 500;">Commission:</label>
                                <input type="number" id="commissionRate" min="0" max="10" step="0.01" value="${tracker ? (tracker.purchaseGoalManager.calculator.commissionRate * 100).toFixed(2) : '0.25'}" style="width: 60px; padding: 4px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 13px;">
                                <span>%</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="font-weight: 500;">Tax:</label>
                                <input type="number" id="taxRate" min="0" max="50" step="0.1" value="${tracker ? (tracker.purchaseGoalManager.calculator.taxRate * 100).toFixed(1) : '32.5'}" style="width: 60px; padding: 4px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 13px;">
                                <span>%</span>
                            </div>
                            <button onclick="updateCommissionSettings()" style="background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px;">Update</button>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center; font-size: 13px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="font-weight: 500;">Sales Rate:</label>
                                <button id="salesRateToggle" onclick="toggleSalesRateMode()" style="background: ${tracker && tracker.salesRateMode === 'auto' ? 'var(--success)' : 'var(--warning)'}; color: white; border: none; padding: 2px 6px; border-radius: 2px; cursor: pointer; font-size: 11px; min-width: 50px;">${tracker ? (tracker.salesRateMode === 'auto' ? 'Auto' : 'Manual') : 'Auto'}</button>
                                <input type="number" id="manualSalesRate" min="0" step="100" value="${tracker ? tracker.manualSalesRate : 1000}" style="width: 80px; padding: 4px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 13px; ${!tracker || tracker.salesRateMode === 'auto' ? 'opacity: 0.5;' : ''}" ${!tracker || tracker.salesRateMode === 'auto' ? 'disabled' : ''} onchange="updateManualSalesRate()">
                                <span>/day</span>
                                <span id="currentRateDisplay" style="margin-left: 10px; color: var(--text-secondary); font-size: 11px;">(Current: $${tracker ? tracker.getCurrentEarningRate().toFixed(0) : '0'}/day)</span>
                            </div>
                        </div>
                    </div>
                
                    <!-- Add New Goal -->
                    <div style="border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; margin-bottom: 10px; width: 100%; max-width: 800px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 15px; color: var(--text-primary);">Add New Goal</h3>
                        <div style="display: flex; gap: 8px; align-items: center; font-size: 13px; flex-wrap: wrap;">
                            <span id="newGoalIconDisplay" style="font-size: 16px; cursor: pointer;" onclick="showIconPicker()">üéØ</span>
                            <input type="text" id="newGoalName" placeholder="Item name" style="width: 200px; min-width: 150px; padding: 4px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 13px;">
                            <span>$</span>
                            <input type="number" id="newGoalCost" placeholder="1200" min="1" step="1" style="width: 70px; padding: 4px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 13px;">
                            <button onclick="addPurchaseGoal()" style="background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px;">Add</button>
                        </div>
                    </div>
                    
                    <!-- Goals List -->
                    <div style="flex: 1; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 10px; display: flex; flex-direction: column; min-height: 0; width: 100%; max-width: 800px;">
                        <h3 style="margin: 0; padding: 8px 12px; background: var(--bg-accent); border-bottom: 1px solid #ddd; font-size: 14px; color: var(--text-primary);">Next</h3>
                        <div id="purchaseGoalsList" style="flex: 1; padding: 6px; overflow-y: auto;">
                            <!-- Goals will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Monthly Progress Visualization -->
                    <div style="background: var(--bg-tertiary); padding: 10px; border-radius: 4px; width: 100%; max-width: 800px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 14px; color: var(--text-primary);">Monthly Revenue Path</h3>
                        <div id="revenuePath" style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 3px; height: 60px; position: relative; overflow: visible; margin-bottom: 20px;">
                            <!-- Progress visualization will be here -->
                        </div>
                        <div id="revenuePathLabels" style="font-size: 11px; color: var(--text-secondary);">
                            <!-- Labels will be here -->
                        </div>
                    </div>
                    
                    <!-- Backup System -->
                    <div style="background: var(--bg-accent); padding: 10px; border-radius: 4px; margin-top: 10px; width: 100%; max-width: 500px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 15px; color: var(--text-primary);">Backup & Sync</h3>
                        <div style="display: flex; gap: 10px; align-items: center; font-size: 13px; flex-wrap: wrap;">
                            <button onclick="exportBackup()" style="background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px;">üíæ Export Backup</button>
                            <button onclick="importBackup()" style="background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px;">üìÇ Import Backup</button>
                            <span style="color: var(--text-secondary); font-size: 11px; margin-left: 10px;">Chrome required</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Populate the goals list
            if (tracker) {
                populatePurchaseGoalsList();
                updateRevenuePathVisualization();
                updateSalesRateDisplay();
            }
        }

        function toggleSalesRateMode() {
            if (!tracker) return;
            
            tracker.salesRateMode = tracker.salesRateMode === 'auto' ? 'manual' : 'auto';
            tracker.saveData();
            
            // Update UI
            const toggle = document.getElementById('salesRateToggle');
            const input = document.getElementById('manualSalesRate');
            
            if (tracker.salesRateMode === 'auto') {
                toggle.textContent = 'Auto';
                toggle.style.background = 'var(--success)';
                input.disabled = true;
                input.style.opacity = '0.5';
            } else {
                toggle.textContent = 'Manual';
                toggle.style.background = 'var(--warning)';
                input.disabled = false;
                input.style.opacity = '1';
            }
            
            updateSalesRateDisplay();
            populatePurchaseGoalsList(); // Refresh time estimates
        }

        function updateManualSalesRate() {
            if (!tracker) return;
            
            const rate = parseFloat(document.getElementById('manualSalesRate').value) || 1000;
            tracker.manualSalesRate = rate;
            tracker.saveData();
            
            updateSalesRateDisplay();
            populatePurchaseGoalsList(); // Refresh time estimates
        }

        function updateSalesRateDisplay() {
            const display = document.getElementById('currentRateDisplay');
            if (display && tracker) {
                display.textContent = `(Current: $${tracker.getCurrentEarningRate().toFixed(0)}/day)`;
            }
        }

        // History Functions (Sales + Daily Progress)
        function populateSalesHistory() {
            const container = document.getElementById('salesHistoryContent');
            if (!container || !tracker) return;

            // Combine sales history and daily progress
            const allData = [];
            
            // Get unique dates from both sources
            const uniqueDates = new Set();
            tracker.salesHistory.forEach(entry => uniqueDates.add(entry.date));
            (tracker.dailyProgress || []).forEach(entry => uniqueDates.add(entry.date));
            
            // Create combined entries
            Array.from(uniqueDates).forEach(date => {
                const salesEntry = tracker.salesHistory.find(s => s.date === date);
                const progressEntry = tracker.dailyProgress.find(p => p.date === date);
                
                allData.push({
                    date: date,
                    revenue: salesEntry ? salesEntry.amount : 0,
                    activity: progressEntry ? progressEntry.activity : 0,
                    calls: progressEntry ? progressEntry.calls : 0,
                    tasks: progressEntry ? progressEntry.tasks : 0
                });
            });
            
            // Sort by date (newest first)
            allData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allData.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px;">
                        No data recorded yet. Your daily activity will appear here automatically.
                    </div>
                `;
                return;
            }

            // Group by month
            const monthGroups = {};
            allData.forEach(entry => {
                const month = entry.date.substring(0, 7); // YYYY-MM
                if (!monthGroups[month]) {
                    monthGroups[month] = {
                        entries: [],
                        totalRevenue: 0,
                        avgActivity: 0,
                        avgCalls: 0,
                        avgTasks: 0
                    };
                }
                monthGroups[month].entries.push(entry);
                monthGroups[month].totalRevenue += entry.revenue;
            });

            // Calculate averages for each month
            Object.keys(monthGroups).forEach(month => {
                const group = monthGroups[month];
                const validEntries = group.entries.filter(e => e.activity > 0 || e.calls > 0 || e.tasks > 0);
                const count = Math.max(validEntries.length, 1);
                
                group.avgActivity = validEntries.reduce((sum, e) => sum + e.activity, 0) / count;
                group.avgCalls = validEntries.reduce((sum, e) => sum + e.calls, 0) / count;
                group.avgTasks = validEntries.reduce((sum, e) => sum + e.tasks, 0) / count;
            });

            let html = '';
            Object.keys(monthGroups).sort().reverse().forEach(month => {
                const group = monthGroups[month];
                const monthName = new Date(month + '-01').toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long' 
                });
                
                html += `
                    <div style="border-bottom: 1px solid var(--border-light);">
                        <div onclick="toggleMonthSection('${month}')" style="padding: 8px 12px; background: var(--bg-accent); cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-light);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span id="toggle-${month}" style="font-size: 12px; transition: transform 0.2s;">‚ñº</span>
                                <span style="font-weight: 500; color: var(--text-primary);">${monthName}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; font-size: 11px;">
                                <span style="color: var(--success);">$${(group.totalRevenue/1000).toFixed(1)}K</span>
                                <span style="color: var(--text-secondary);">üìä${group.avgActivity.toFixed(0)}</span>
                                <span style="color: var(--text-secondary);">üìû${group.avgCalls.toFixed(0)}</span>
                                <span style="color: var(--text-secondary);">‚úÖ${group.avgTasks.toFixed(0)}</span>
                                <span style="color: var(--text-muted);">(${group.entries.length})</span>
                            </div>
                        </div>
                        <div id="month-${month}" style="display: block;">
                            ${group.entries.map(entry => `
                                <div style="padding: 6px 12px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-light); font-size: 11px;">
                                    <span style="color: var(--text-primary); font-weight: 500;">${new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="color: var(--success); min-width: 45px;">$${entry.revenue.toLocaleString()}</span>
                                        <span style="color: var(--text-secondary); min-width: 30px;" title="Activity Points">üìä${entry.activity}</span>
                                        <span style="color: var(--text-secondary); min-width: 30px;" title="Calls">üìû${entry.calls}</span>
                                        <span style="color: var(--text-secondary); min-width: 30px;" title="Tasks">‚úÖ${entry.tasks}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleMonthSection(month) {
            const content = document.getElementById(`month-${month}`);
            const toggle = document.getElementById(`toggle-${month}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.style.transform = 'rotate(0deg)';
                toggle.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                toggle.style.transform = 'rotate(-90deg)';
                toggle.textContent = '‚ñ∂';
            }
        }

        function addNewSalesEntry() {
            const today = new Date().toISOString().slice(0, 10);
            const amount = prompt('Enter sales amount:', '1000');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                tracker.addSalesEntry(today, parseFloat(amount), 'manual');
                populateSalesHistory();
                tracker.updateDisplay(); // Refresh main display
            }
        }

        function editSalesDate(originalDate, element) {
            const currentDate = originalDate;
            const newDate = prompt('Edit date (YYYY-MM-DD):', currentDate);
            
            if (newDate && newDate !== currentDate) {
                const entry = tracker.salesHistory.find(e => e.date === originalDate);
                if (entry) {
                    // Remove old entry
                    tracker.salesHistory = tracker.salesHistory.filter(e => e.date !== originalDate);
                    // Add with new date
                    tracker.addSalesEntry(newDate, entry.amount, entry.source);
                    populateSalesHistory();
                    tracker.updateDisplay();
                }
            }
        }

        function editSalesAmount(date, element) {
            const entry = tracker.salesHistory.find(e => e.date === date);
            if (!entry) return;
            
            const newAmount = prompt('Edit sales amount:', entry.amount.toString());
            if (newAmount && !isNaN(newAmount) && parseFloat(newAmount) > 0) {
                entry.amount = parseFloat(newAmount);
                tracker.saveData();
                populateSalesHistory();
                tracker.updateDisplay();
            }
        }

        function editMonthTotal(month, element, event) {
            event.stopPropagation(); // Prevent toggle
            
            const monthEntries = tracker.salesHistory.filter(e => e.date.startsWith(month));
            const currentTotal = monthEntries.reduce((sum, e) => sum + e.amount, 0);
            
            const newTotal = prompt(`Edit total for ${new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}:`, currentTotal.toString());
            
            if (newTotal && !isNaN(newTotal) && parseFloat(newTotal) >= 0) {
                const targetTotal = parseFloat(newTotal);
                
                if (monthEntries.length === 0) {
                    // No entries for this month, create one
                    const lastDay = new Date(new Date(month + '-01').getFullYear(), new Date(month + '-01').getMonth() + 1, 0).getDate();
                    tracker.addSalesEntry(`${month}-${lastDay.toString().padStart(2, '0')}`, targetTotal, 'manual');
                } else {
                    // Adjust existing entries proportionally
                    const ratio = targetTotal / currentTotal;
                    monthEntries.forEach(entry => {
                        entry.amount = Math.round(entry.amount * ratio);
                    });
                    tracker.saveData();
                }
                
                populateSalesHistory();
                tracker.updateDisplay();
            }
        }

        function deleteSalesEntry(date) {
            if (confirm('Delete this sales entry?')) {
                tracker.salesHistory = tracker.salesHistory.filter(e => e.date !== date);
                tracker.saveData();
                populateSalesHistory();
                tracker.updateDisplay();
            }
        }

        // Version and Changelog Functions
        function showChangelog() {
            const changelog = `
üì± Sales Productivity Tracker v1.5.0 - What's New

üéØ MAJOR UPDATES:
‚Ä¢ Fixed monthly revenue to show cumulative totals (not separate tracking)
‚Ä¢ Added working days calculations (excludes weekends) 
‚Ä¢ Enhanced sales rate system with auto/manual toggle
‚Ä¢ Complete backup/restore system with human-readable JSON
‚Ä¢ Sales history section with editable entries and monthly totals

üîß BUG FIXES:
‚Ä¢ Fixed Enter key saving goals properly
‚Ä¢ Fixed immediate visual updates when adding goals
‚Ä¢ Changed default icon from laptop to target
‚Ä¢ Updated "Museum of Triumphs" ‚Üí "Done", "Current Goals" ‚Üí "Next"
‚Ä¢ Fixed backup property mappings for reliable export/import

üìä SALES HISTORY:
‚Ä¢ Collapsible monthly sections with editable totals
‚Ä¢ Click any date or amount to edit directly
‚Ä¢ Sort by recency (newest first)
‚Ä¢ Delete individual entries
‚Ä¢ Add new sales entries easily

‚ö° CALCULATIONS:
‚Ä¢ "Days until" now shows "working days" (excluding weekends)
‚Ä¢ Date projections account for weekends
‚Ä¢ Time estimates: "5wd", "3wk", "2mo" format
‚Ä¢ Auto sales rate based on 30-day history
‚Ä¢ Manual sales rate override option

üíæ BACKUP SYSTEM:
‚Ä¢ Export all data to timestamped JSON files
‚Ä¢ Import from any backup to restore complete state
‚Ä¢ Includes sales history, goals, settings, commission rates
‚Ä¢ Chrome/Chromium browsers supported (File System Access API)

üé® UI IMPROVEMENTS:
‚Ä¢ Better dark mode support across all components
‚Ä¢ Purchase dates shown in "Done" section
‚Ä¢ Sales rate display with current rate indication
‚Ä¢ Cleaner layout and consistent styling
            `;
            
            alert(changelog);
        }

        function populateSettingsPage() {
            const content = document.getElementById('settingsPageContent');
            content.innerHTML = `
                <div style="display: flex; flex-direction: column; height: 100%; padding: 0 10px;">
                    <div style="flex: 1; display: grid; grid-template-columns: 1fr 2fr; gap: 15px; align-content: start;">
                        <!-- Shift Schedule Section -->
                        <div style="background: var(--bg-accent); padding: 12px; border-radius: 4px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px; color: var(--text-primary);">Shift Schedule</h3>
                            <div style="display: grid; gap: 10px;">
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Start Time:</label>
                                    <input type="time" id="settingsShiftStart" value="${tracker ? tracker.shiftStart : '09:00'}" step="1" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px; appearance: none; -webkit-appearance: none; -moz-appearance: none;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">End Time:</label>
                                    <input type="time" id="settingsShiftEnd" value="${tracker ? tracker.shiftEnd : '17:00'}" step="1" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px; appearance: none; -webkit-appearance: none; -moz-appearance: none;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Daily Targets Section -->
                        <div style="background: var(--bg-accent); padding: 12px; border-radius: 4px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px; color: var(--text-primary);">Daily Targets</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Activity Points:</label>
                                    <input type="number" id="settingsTarget" value="${tracker ? tracker.target : 50}" min="1" max="200" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Outbound Calls:</label>
                                    <input type="number" id="settingsCallsTarget" value="${tracker ? tracker.callsTarget : 20}" min="1" max="100" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Today's Tasks:</label>
                                    <input type="number" id="settingsBacklogTarget" value="${tracker ? tracker.backlogTarget : 0}" min="0" max="1000" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Daily Revenue:</label>
                                    <input type="number" id="settingsDailyRevenueTarget" value="${tracker ? tracker.dailyRevenueTarget : 5000}" min="0" max="100000" step="100" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <label style="display: block; margin-bottom: 3px; font-weight: 500; font-size: 13px;">Monthly Revenue:</label>
                                    <input type="number" id="settingsMonthlyRevenueTarget" value="${tracker ? tracker.monthlyRevenueTarget : 50000}" min="0" max="1000000" step="1000" style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 14px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 12px 0; text-align: center; border-top: 1px solid var(--border-light); margin-top: 12px;">
                        <button onclick="saveSettings()" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 3px; cursor: pointer; font-size: 14px; margin-right: 10px;">Save Settings</button>
                        <button onclick="resetData()" style="background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 3px; cursor: pointer; font-size: 14px;">Reset All Data</button>
                    </div>
                </div>
            `;
            
        }
        

        // Show Update Dialog (now opens menu)
        function showUpdateDialog() {
            openMenu();
        }

        // Save Settings Function
        function saveSettings() {
            if (!tracker) {
                console.error('Tracker not initialized yet');
                return;
            }

            // Get values from settings form inputs
            const shiftStart = document.getElementById('settingsShiftStart').value;
            const shiftEnd = document.getElementById('settingsShiftEnd').value;
            const target = parseInt(document.getElementById('settingsTarget').value) || 50;
            const callsTarget = parseInt(document.getElementById('settingsCallsTarget').value) || 20;
            const backlogTarget = parseInt(document.getElementById('settingsBacklogTarget').value) || 0;
            const dailyRevenueTarget = parseInt(document.getElementById('settingsDailyRevenueTarget').value) || 5000;
            const monthlyRevenueTarget = parseInt(document.getElementById('settingsMonthlyRevenueTarget').value) || 50000;

            // Update tracker properties
            tracker.shiftStart = shiftStart;
            tracker.shiftEnd = shiftEnd;
            tracker.target = target;
            tracker.callsTarget = callsTarget;
            tracker.backlogTarget = backlogTarget;
            tracker.dailyRevenueTarget = dailyRevenueTarget;
            tracker.monthlyRevenueTarget = monthlyRevenueTarget;

            // Save to localStorage
            tracker.saveData();

            // Update display
            tracker.updateDisplay();
            tracker.updateTimeMarkers();
            tracker.updateMonthlyRevenueMilestones();

            // Show success message
            showSuccessIndicator('Settings saved successfully!');

            // Close menu
            closeMenu();
        }

        function saveProgressAndSettings() {
            if (!tracker) return;
            
            // Save Progress Data
            const activityInput = document.getElementById('menuActivityInput');
            const callsInput = document.getElementById('menuCallsInput');
            const backlogInput = document.getElementById('menuBacklogInput');
            const dailyRevenueInput = document.getElementById('menuDailyRevenueInput');
            const monthlyRevenueInput = document.getElementById('menuMonthlyRevenueInput');
            
            const points = parseInt(activityInput.value) || 0;
            const calls = parseInt(callsInput.value) || 0;
            const backlogRemaining = parseInt(backlogInput.value) || 0;
            const dailyRevenue = parseInt(dailyRevenueInput.value) || 0;
            const monthlyRevenue = parseInt(monthlyRevenueInput.value) || 0;
            
            // Update tracker progress data
            tracker.currentPoints = points;
            tracker.currentCalls = calls;
            tracker.currentBacklog = completedTasks; // Now directly completed tasks
            tracker.currentDailyRevenue = dailyRevenue;
            
            // Sync monthly revenue with sales history
            const currentMonthRevenue = tracker.getMonthlyRevenueFromHistory();
            if (monthlyRevenue !== currentMonthRevenue) {
                tracker.updateCurrentMonthRevenue(monthlyRevenue);
                populateSalesHistory(); // Refresh sales history display
            }

            // Save Settings Data
            const shiftStart = document.getElementById('settingsShiftStart').value;
            const shiftEnd = document.getElementById('settingsShiftEnd').value;
            const target = parseInt(document.getElementById('settingsTarget').value) || 50;
            const callsTarget = parseInt(document.getElementById('settingsCallsTarget').value) || 20;
            const backlogTarget = parseInt(document.getElementById('settingsBacklogTarget').value) || 0;
            const dailyRevenueTarget = parseInt(document.getElementById('settingsDailyRevenueTarget').value) || 5000;
            const monthlyRevenueTarget = parseInt(document.getElementById('settingsMonthlyRevenueTarget').value) || 50000;

            // Update tracker settings
            tracker.shiftStart = shiftStart;
            tracker.shiftEnd = shiftEnd;
            tracker.target = target;
            tracker.callsTarget = callsTarget;
            tracker.backlogTarget = backlogTarget;
            tracker.dailyRevenueTarget = dailyRevenueTarget;
            tracker.monthlyRevenueTarget = monthlyRevenueTarget;

            // Auto-record today's revenue to sales history
            tracker.autoRecordTodaysRevenue();

            // Save to localStorage
            tracker.saveData();

            // Update display
            tracker.updateDisplay();
            tracker.updateTimeMarkers();
            tracker.updateMonthlyRevenueMilestones();

            // Show success message
            showSuccessIndicator('Progress and settings saved successfully!');

            // Close menu
            closeMenu();
        }

            


        // Purchase Goal Icon System
        const GOAL_ICONS = {
            'laptop': 'üíª',
            'computer': 'üñ•Ô∏è',
            'phone': 'üì±',
            'car': 'üöó',
            'vacation': '‚úàÔ∏è',
            'house': 'üè†',
            'camera': 'üì∑',
            'watch': '‚åö',
            'bike': 'üö≤',
            'game': 'üéÆ',
            'music': 'üéµ',
            'book': 'üìö',
            'shoes': 'üëü',
            'keyboard': '‚å®Ô∏è',
            'default': 'üéØ'
        };

        function getIconForGoal(goalName, goalIconType = null) {
            // If explicit icon type is provided, use it
            if (goalIconType && GOAL_ICONS[goalIconType]) {
                return GOAL_ICONS[goalIconType];
            }
            
            // Otherwise fall back to name-based detection
            const name = goalName.toLowerCase();
            
            if (name.includes('laptop') || name.includes('macbook') || name.includes('pc')) return GOAL_ICONS.laptop;
            if (name.includes('monitor') || name.includes('screen') || name.includes('display')) return GOAL_ICONS.computer;
            if (name.includes('phone') || name.includes('iphone') || name.includes('android')) return GOAL_ICONS.phone;
            if (name.includes('car') || name.includes('vehicle') || name.includes('auto')) return GOAL_ICONS.car;
            if (name.includes('vacation') || name.includes('trip') || name.includes('travel')) return GOAL_ICONS.vacation;
            if (name.includes('house') || name.includes('home') || name.includes('apartment')) return GOAL_ICONS.house;
            if (name.includes('camera') || name.includes('photo')) return GOAL_ICONS.camera;
            if (name.includes('watch') || name.includes('time')) return GOAL_ICONS.watch;
            if (name.includes('bike') || name.includes('bicycle') || name.includes('cycle')) return GOAL_ICONS.bike;
            if (name.includes('game') || name.includes('gaming') || name.includes('console')) return GOAL_ICONS.game;
            if (name.includes('music') || name.includes('audio') || name.includes('speaker')) return GOAL_ICONS.music;
            if (name.includes('book') || name.includes('read')) return GOAL_ICONS.book;
            if (name.includes('shoes') || name.includes('sneakers') || name.includes('boots')) return GOAL_ICONS.shoes;
            if (name.includes('keyboard') || name.includes('mechanical')) return GOAL_ICONS.keyboard;
            
            return GOAL_ICONS.default;
        }

        // Commission and Purchase Goal Utilities
        class RevenueCalculator {
            constructor(commissionRate = 0.0025, taxRate = 0.325) {
                this.commissionRate = commissionRate;  // 0.25%
                this.taxRate = taxRate;                 // 32.5%
                this.netRate = commissionRate * (1 - taxRate);  // Final rate after tax
            }
            
            // Calculate net income from gross revenue
            calculateNetIncome(revenue) {
                return revenue * this.netRate;
            }
            
            // Calculate required revenue for desired net income
            calculateRequiredRevenue(netIncome) {
                return netIncome / this.netRate;
            }
            
            // Calculate required revenue for purchase cost
            calculateRevenueForPurchase(purchaseCost) {
                return this.calculateRequiredRevenue(purchaseCost);
            }
        }

        class PurchaseGoalManager {
            constructor() {
                this.goals = [];
                this.calculator = new RevenueCalculator();
                this.storageKey = 'purchaseGoals';
                this.load();
            }
            
            load() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        this.goals = JSON.parse(stored);
                        this.goals.forEach(goal => {
                            if (!goal.id) goal.id = this.generateId();
                            if (!goal.requiredRevenue) {
                                goal.requiredRevenue = Math.round(this.calculator.calculateRevenueForPurchase(goal.cost));
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading purchase goals:', error);
                    this.goals = [];
                }
            }
            
            save() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.goals));
                } catch (error) {
                    console.error('Error saving purchase goals:', error);
                }
            }
            
            generateId() {
                return 'goal_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            addGoal(name, cost) {
                const goal = {
                    id: this.generateId(),
                    name: name.trim(),
                    cost: parseFloat(cost),
                    requiredRevenue: Math.round(this.calculator.calculateRevenueForPurchase(cost)),
                    purchased: false,
                    order: this.goals.length,
                    createdAt: new Date().toISOString()
                };
                
                this.goals.push(goal);
                this.save();
                return goal;
            }
            
            removeGoal(goalId) {
                this.goals = this.goals.filter(goal => goal.id !== goalId);
                this.reorderGoals();
                this.save();
            }
            
            updateGoal(goalId, updates) {
                const goal = this.goals.find(g => g.id === goalId);
                if (goal) {
                    if (updates.name !== undefined) goal.name = updates.name.trim();
                    if (updates.cost !== undefined) {
                        goal.cost = parseFloat(updates.cost);
                        goal.requiredRevenue = Math.round(this.calculator.calculateRevenueForPurchase(goal.cost));
                    }
                    if (updates.purchased !== undefined) {
                        goal.purchased = updates.purchased;
                        // Set purchase date when marking as purchased
                        if (updates.purchased) {
                            goal.purchaseDate = new Date().toISOString().slice(0, 10);
                        } else {
                            goal.purchaseDate = null;
                        }
                    }
                    this.save();
                }
                return goal;
            }
            
            reorderGoals() {
                this.goals.forEach((goal, index) => {
                    goal.order = index;
                });
                this.save();
            }
            
            moveGoal(fromIndex, toIndex) {
                if (fromIndex === toIndex) return;
                
                const [movedGoal] = this.goals.splice(fromIndex, 1);
                this.goals.splice(toIndex, 0, movedGoal);
                this.reorderGoals();
            }
            
            getGoalsSorted() {
                return [...this.goals].sort((a, b) => {
                    // Purchased goals always come first, then by order
                    if (a.purchased && !b.purchased) return -1;
                    if (!a.purchased && b.purchased) return 1;
                    return a.order - b.order;
                });
            }
            
            calculateProgress(currentRevenue) {
                const sortedGoals = this.getGoalsSorted();
                let cumulativeRevenue = 0;
                
                return sortedGoals.map((goal, index) => {
                    const startRevenue = cumulativeRevenue;
                    cumulativeRevenue += goal.requiredRevenue;
                    
                    return {
                        ...goal,
                        startRevenue,
                        endRevenue: cumulativeRevenue,
                        progress: Math.max(0, Math.min(1, (currentRevenue - startRevenue) / goal.requiredRevenue)),
                        achieved: currentRevenue >= cumulativeRevenue
                    };
                });
            }
        }

        class ActivityTracker {
            constructor() {
                this.currentPoints = 0;
                this.currentCalls = 0;
                this.currentBacklog = 0;
                this.currentDailyRevenue = 0;
                this.currentMonthlyRevenue = 0;
                this.target = 50;
                this.callsTarget = 20;
                this.backlogTarget = 0;
                this.dailyRevenueTarget = 5000;
                this.monthlyRevenueTarget = 50000;
                this.shiftStart = '09:00';
                this.shiftEnd = '17:00';
                this.isEndTimeLocked = true;
                this.salesHistory = []; // Array of {date: 'YYYY-MM-DD', amount: number, source: 'auto'|'manual'}
                this.dailyProgress = []; // Array of {date: 'YYYY-MM-DD', activity: number, calls: number, tasks: number, revenue: number}
                this.salesRateMode = 'auto'; // 'auto' or 'manual'
                this.manualSalesRate = 1000; // Manual daily sales rate
                
                this.purchaseGoalManager = new PurchaseGoalManager();
                
                this.loadData();
                this.setupEventListeners();
                this.updateDisplay();
                this.startUpdateLoop();
            }

            loadData() {
                const data = localStorage.getItem('activityTracker');
                if (data) {
                    const parsed = JSON.parse(data);
                    const today = new Date().toDateString();
                    const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                    
                    if (parsed.date === today) {
                        this.currentPoints = parsed.currentPoints || 0;
                        this.currentCalls = parsed.currentCalls || 0;
                        this.currentBacklog = parsed.currentBacklog || 0;
                        this.currentDailyRevenue = parsed.currentDailyRevenue || 0;
                        this.target = parsed.target || 50;
                        this.callsTarget = parsed.callsTarget || 20;
                        this.backlogTarget = parsed.backlogTarget || 0;
                        this.dailyRevenueTarget = parsed.dailyRevenueTarget || 5000;
                        this.shiftStart = parsed.shiftStart || '09:00';
                        this.shiftEnd = parsed.shiftEnd || '17:00';
                    }
                    
                    // Monthly revenue persists across days within the same month
                    if (parsed.month === currentMonth) {
                        this.currentMonthlyRevenue = parsed.currentMonthlyRevenue || 0;
                        this.monthlyRevenueTarget = parsed.monthlyRevenueTarget || 50000;
                    }
                    
                    // Load sales history and rate settings
                    this.salesHistory = parsed.salesHistory || [];
                    this.dailyProgress = parsed.dailyProgress || [];
                    this.salesRateMode = parsed.salesRateMode || 'auto';
                    this.manualSalesRate = parsed.manualSalesRate || 1000;
                }
            }

            saveData() {
                const data = {
                    date: new Date().toDateString(),
                    month: new Date().toISOString().slice(0, 7),
                    currentPoints: this.currentPoints,
                    currentCalls: this.currentCalls,
                    currentBacklog: this.currentBacklog,
                    currentDailyRevenue: this.currentDailyRevenue,
                    currentMonthlyRevenue: this.currentMonthlyRevenue,
                    target: this.target,
                    callsTarget: this.callsTarget,
                    backlogTarget: this.backlogTarget,
                    dailyRevenueTarget: this.dailyRevenueTarget,
                    monthlyRevenueTarget: this.monthlyRevenueTarget,
                    shiftStart: this.shiftStart,
                    shiftEnd: this.shiftEnd,
                    salesHistory: this.salesHistory,
                    dailyProgress: this.dailyProgress,
                    salesRateMode: this.salesRateMode,
                    manualSalesRate: this.manualSalesRate
                };
                localStorage.setItem('activityTracker', JSON.stringify(data));
            }

            setupEventListeners() {
                // Click any progress bar to update all metrics
                const activityBar = document.getElementById('activityBar');
                const callsBar = document.getElementById('callsBar');
                const backlogBar = document.getElementById('backlogBar');
                const dailyRevenueBar = document.getElementById('dailyRevenueBar');
                const monthlyRevenueBar = document.getElementById('monthlyRevenueBar');
                
                const bars = [activityBar, callsBar, backlogBar, dailyRevenueBar, monthlyRevenueBar];
                
                bars.forEach(bar => {
                    if (bar) {
                        bar.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openMenu();
                        });
                    }
                });

                // Right click
                document.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    // Right click opens menu instead of context menu
                    openMenu();
                });
                
                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    // Handle Esc key for any open dialog
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        closeMenu();
                        hideIconPicker();
                        return;
                    }
                    
                    // Don't interfere if typing in inputs or menu is open or clicking buttons
                    if (e.target.tagName === 'INPUT' || 
                        e.target.tagName === 'BUTTON' ||
                        document.getElementById('menuOverlay').classList.contains('active')) {
                        return;
                    }
                    
                    switch(e.key) {
                        case 'Enter':
                        case ' ':
                            e.preventDefault();
                            openMenu();
                            break;
                        case 's':
                        case 'S':
                        case 'g':
                        case 'G':
                            e.preventDefault();
                            openMenu();
                            break;
                    }
                });

                // Click elsewhere to close menus
                document.addEventListener('click', (e) => {
                    // No context menu to manage
                });
            }



            updateDisplay() {
                const now = new Date();
                const [shiftStartHour, shiftStartMin] = this.shiftStart.split(':').map(Number);
                const [shiftEndHour, shiftEndMin] = this.shiftEnd.split(':').map(Number);
                
                const shiftStartTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), shiftStartHour, shiftStartMin);
                const shiftEndTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), shiftEndHour, shiftEndMin);
                
                // Handle overnight shifts
                if (shiftEndTime <= shiftStartTime) {
                    shiftEndTime.setDate(shiftEndTime.getDate() + 1);
                }
                
                const shiftDuration = shiftEndTime - shiftStartTime;
                const elapsedTime = Math.max(0, Math.min(now - shiftStartTime, shiftDuration));
                const timeProgress = elapsedTime / shiftDuration;
                
                // Update time markers
                this.updateTimeMarkers();
                
                // Update all expected lines (daily time-based)
                const expectedLine1 = document.getElementById('expectedLine1');
                const expectedLine2 = document.getElementById('expectedLine2');
                const expectedLine3 = document.getElementById('expectedLine3');
                const expectedLine4 = document.getElementById('expectedLine4');
                if (expectedLine1) expectedLine1.style.left = (timeProgress * 100) + '%';
                if (expectedLine2) expectedLine2.style.left = (timeProgress * 100) + '%';
                if (expectedLine3) expectedLine3.style.left = (timeProgress * 100) + '%';
                if (expectedLine4) expectedLine4.style.left = (timeProgress * 100) + '%';
                
                // Monthly time indicator (based on day of month)
                const currentDay = now.getDate();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const monthProgress = (currentDay - 1) / (daysInMonth - 1); // 0-1 scale
                const expectedLine5 = document.getElementById('expectedLine5');
                if (expectedLine5) expectedLine5.style.left = (monthProgress * 100) + '%';
                
                // Update activity progress
                const activityProgress = this.currentPoints / this.target;
                const activityFill = document.getElementById('activityFill');
                if (activityFill) {
                    activityFill.style.width = Math.max(0.5, activityProgress * 100) + '%';
                    
                    // Color coding for activity
                    const expectedPoints = timeProgress * this.target;
                    const activityRatio = this.currentPoints / expectedPoints;
                    const activityCompletionRatio = this.currentPoints / this.target;
                    
                    activityFill.className = 'activity-fill';
                    if (activityCompletionRatio >= 1.0) {
                        activityFill.classList.add('complete'); // Gold for 100%+ completion
                    } else if (activityRatio >= 1.0) {
                        activityFill.classList.add('ahead');
                    } else if (activityRatio >= 0.9) {
                        activityFill.classList.add('close');
                    } else {
                        activityFill.classList.add('behind');
                    }
                }
                
                // Update calls progress
                const callsProgress = this.currentCalls / this.callsTarget;
                const callsFill = document.getElementById('callsFill');
                if (callsFill) {
                    callsFill.style.width = Math.max(0.5, callsProgress * 100) + '%';
                    
                    // Color coding for calls
                    const expectedCalls = timeProgress * this.callsTarget;
                    const callsRatio = this.currentCalls / expectedCalls;
                    const callsCompletionRatio = this.currentCalls / this.callsTarget;
                    
                    callsFill.className = 'activity-fill';
                    if (callsCompletionRatio >= 1.0) {
                        callsFill.classList.add('complete'); // Gold for 100%+ completion
                    } else if (callsRatio >= 1.0) {
                        callsFill.classList.add('ahead');
                    } else if (callsRatio >= 0.9) {
                        callsFill.classList.add('close');
                    } else {
                        callsFill.classList.add('behind');
                    }
                }
                
                // Update backlog progress (countdown logic)
                const backlogFill = document.getElementById('backlogFill');
                if (this.backlogTarget > 0) {
                    // For countdown: progress = (target - current) / target
                    const backlogProgress = Math.max(0, this.currentBacklog / this.backlogTarget);
                    
                    if (backlogFill) {
                        backlogFill.style.width = Math.max(0.5, backlogProgress * 100) + '%';
                        
                        // Color coding for backlog based on expected progress
                        const expectedBacklogCompleted = timeProgress * this.backlogTarget;
                        const backlogRatio = expectedBacklogCompleted > 0 ? this.currentBacklog / expectedBacklogCompleted : 0;
                        
                        backlogFill.className = 'activity-fill';
                        if (this.currentBacklog === this.backlogTarget && this.backlogTarget > 0) {
                            backlogFill.classList.add('complete'); // Gold when all tasks completed
                        } else if (backlogRatio >= 1.0) {
                            backlogFill.classList.add('ahead');
                        } else if (backlogRatio >= 0.9) {
                            backlogFill.classList.add('close');
                        } else {
                            backlogFill.classList.add('behind');
                        }
                    }
                } else {
                    // If no backlog target set, hide the progress bar
                    if (backlogFill) {
                        backlogFill.style.width = '0%';
                        backlogFill.className = 'activity-fill';
                    }
                }
                
                // Update daily revenue progress
                const dailyRevenueProgress = this.currentDailyRevenue / this.dailyRevenueTarget;
                const dailyRevenueFill = document.getElementById('dailyRevenueFill');
                if (dailyRevenueFill) {
                    // Cap progress bar at 100% to prevent overflow
                    const cappedProgress = Math.min(dailyRevenueProgress, 1.0);
                    dailyRevenueFill.style.width = Math.max(0.5, cappedProgress * 100) + '%';
                    
                    // Add multiplier if over 100%
                    if (dailyRevenueProgress > 1.0) {
                        const multiplier = dailyRevenueProgress.toFixed(1);
                        dailyRevenueFill.setAttribute('data-multiplier', `(${multiplier}x)`);
                    } else {
                        dailyRevenueFill.removeAttribute('data-multiplier');
                    }
                    
                    // Color coding for daily revenue
                    const expectedDailyRevenue = timeProgress * this.dailyRevenueTarget;
                    const dailyRevenueRatio = this.currentDailyRevenue / expectedDailyRevenue;
                    const dailyRevenueCompletionRatio = this.currentDailyRevenue / this.dailyRevenueTarget;
                    
                    dailyRevenueFill.className = 'activity-fill';
                    if (dailyRevenueCompletionRatio >= 1.0) {
                        dailyRevenueFill.classList.add('complete');
                    } else if (dailyRevenueRatio >= 1.0) {
                        dailyRevenueFill.classList.add('ahead');
                    } else if (dailyRevenueRatio >= 0.9) {
                        dailyRevenueFill.classList.add('close');
                    } else {
                        dailyRevenueFill.classList.add('behind');
                    }
                }
                
                // Update monthly revenue progress
                const monthlyRevenueProgress = this.getMonthlyRevenueFromHistory() / this.monthlyRevenueTarget;
                const monthlyRevenueFill = document.getElementById('monthlyRevenueFill');
                if (monthlyRevenueFill) {
                    monthlyRevenueFill.style.width = Math.max(0.5, monthlyRevenueProgress * 100) + '%';
                    
                    // Color coding for monthly revenue based on month progress
                    const expectedMonthlyRevenue = monthProgress * this.monthlyRevenueTarget;
                    const monthlyRevenueRatio = this.getMonthlyRevenueFromHistory() / expectedMonthlyRevenue;
                    const monthlyRevenueCompletionRatio = this.getMonthlyRevenueFromHistory() / this.monthlyRevenueTarget;
                    
                    monthlyRevenueFill.className = 'activity-fill';
                    if (monthlyRevenueCompletionRatio >= 1.0) {
                        monthlyRevenueFill.classList.add('complete');
                    } else if (monthlyRevenueRatio >= 1.0) {
                        monthlyRevenueFill.classList.add('ahead');
                    } else if (monthlyRevenueRatio >= 0.9) {
                        monthlyRevenueFill.classList.add('close');
                    } else {
                        monthlyRevenueFill.classList.add('behind');
                    }
                    
                    // Add milestone icons to monthly revenue bar
                    this.updateMonthlyRevenueMilestones();
                }
                
                // Update displays
                const activityDisplay = document.getElementById('activityDisplay');
                const callsDisplay = document.getElementById('callsDisplay');
                const backlogDisplay = document.getElementById('backlogDisplay');
                const dailyRevenueDisplay = document.getElementById('dailyRevenueDisplay');
                const monthlyRevenueDisplay = document.getElementById('monthlyRevenueDisplay');
                
                if (activityDisplay) activityDisplay.textContent = `${this.currentPoints}/${this.target}`;
                if (callsDisplay) callsDisplay.textContent = `${this.currentCalls}/${this.callsTarget}`;
                if (backlogDisplay) backlogDisplay.textContent = `${this.currentBacklog}/${this.backlogTarget}`;
                if (dailyRevenueDisplay) dailyRevenueDisplay.textContent = `$${(this.currentDailyRevenue/1000).toFixed(1)}K`;
                if (monthlyRevenueDisplay) monthlyRevenueDisplay.textContent = `$${(this.getMonthlyRevenueFromHistory()/1000).toFixed(1)}K`;
            }

            updateTimeMarkers() {
                const [startHour] = this.shiftStart.split(':').map(Number);
                const [endHour] = this.shiftEnd.split(':').map(Number);
                
                const markers = document.querySelectorAll('.time-marker');
                markers.forEach((marker, index) => {
                    const hour = startHour + index;
                    const displayHour = hour > 24 ? hour - 24 : hour;
                    marker.textContent = displayHour.toString().padStart(2, '0');
                    marker.style.left = (index / (markers.length - 1) * 100) + '%';
                });
            }
            
            updateMonthlyRevenueMilestones() {
                const monthlyRevenueBar = document.getElementById('monthlyRevenueBar');
                if (!monthlyRevenueBar || !this.purchaseGoalManager) return;
                
                // Remove existing milestone icons and future goals indicator
                const existingMilestones = monthlyRevenueBar.querySelectorAll('.milestone-icon, .future-goals-indicator');
                existingMilestones.forEach(icon => icon.remove());
                
                // Get purchase goals with progress calculation
                const goalsWithProgress = this.purchaseGoalManager.calculateProgress(this.getMonthlyRevenueFromHistory());
                
                // Separate goals that fit within monthly target vs beyond
                const currentMonthGoals = [];
                const futureGoals = [];
                
                goalsWithProgress.forEach(goal => {
                    const position = (goal.endRevenue / this.monthlyRevenueTarget) * 100;
                    if (position <= 100) {
                        currentMonthGoals.push({ ...goal, position });
                    } else {
                        futureGoals.push(goal);
                    }
                });
                
                // Find next goal (first unachieved goal)
                const nextGoal = currentMonthGoals.find(goal => !goal.achieved);
                
                // Add milestone icons for current month goals
                currentMonthGoals.forEach(goal => {
                    const milestoneIcon = document.createElement('div');
                    milestoneIcon.className = 'milestone-icon';
                    milestoneIcon.textContent = getIconForGoal(goal.name, goal.iconType);
                    milestoneIcon.title = `${goal.name} - $${goal.cost.toLocaleString()}`;
                    
                    // Prevent overlap with revenue display (positioned at right: 6px, roughly equivalent to 90%+ position)
                    let adjustedPosition = goal.position;
                    if (adjustedPosition > 88) {
                        adjustedPosition = 88; // Keep it left of the revenue display
                    }
                    milestoneIcon.style.left = adjustedPosition + '%';
                    
                    // Style based on achievement status
                    if (goal.achieved) {
                        milestoneIcon.classList.add('achieved');
                    } else if (goal.progress > 0) {
                        milestoneIcon.classList.add('in-progress');
                    } else {
                        milestoneIcon.classList.add('pending');
                    }
                    
                    // Add remaining revenue indicator for next goal
                    if (goal === nextGoal && !goal.achieved) {
                        const remaining = goal.endRevenue - this.getMonthlyRevenueFromHistory();
                        const remainingIndicator = document.createElement('div');
                        remainingIndicator.style.cssText = `
                            position: absolute;
                            top: 25px;
                            left: 50%;
                            transform: translateX(-50%);
                            background: rgba(0, 122, 204, 0.9);
                            color: white;
                            padding: 2px 6px;
                            border-radius: 8px;
                            font-size: 9px;
                            white-space: nowrap;
                            z-index: 15;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                        `;
                        remainingIndicator.textContent = `$${(remaining/1000).toFixed(1)}K to go (${(((goal.endRevenue - remaining) / goal.endRevenue) * 100).toFixed(0)}%)`;
                        milestoneIcon.appendChild(remainingIndicator);
                    }
                    
                    monthlyRevenueBar.appendChild(milestoneIcon);
                });
                
                // Future goals indicator removed as requested
            }

            startUpdateLoop() {
                this.updateDisplay();
                setInterval(() => this.updateDisplay(), 5 * 60 * 1000); // 5 minutes
            }

            // Sales History Management
            addSalesEntry(date, amount, source = 'manual') {
                const dateStr = typeof date === 'string' ? date : date.toISOString().slice(0, 10);
                
                // Remove existing entry for this date if it exists
                this.salesHistory = this.salesHistory.filter(entry => entry.date !== dateStr);
                
                // Add new entry
                this.salesHistory.push({
                    date: dateStr,
                    amount: amount,
                    source: source
                });
                
                // Sort by date
                this.salesHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                this.saveData();
            }

            getMonthlyRevenueFromHistory() {
                const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                const monthlyEntries = this.salesHistory.filter(entry => entry.date.startsWith(currentMonth));
                return monthlyEntries.reduce((sum, entry) => sum + entry.amount, 0);
            }

            updateCurrentMonthRevenue(newTotal) {
                const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                const monthlyEntries = this.salesHistory.filter(entry => entry.date.startsWith(currentMonth));
                const currentTotal = monthlyEntries.reduce((sum, entry) => sum + entry.amount, 0);
                
                if (monthlyEntries.length === 0) {
                    // No entries for this month, create one
                    const today = new Date().toISOString().slice(0, 10);
                    this.addSalesEntry(today, newTotal, 'manual');
                } else if (newTotal === 0) {
                    // Remove all entries for this month
                    this.salesHistory = this.salesHistory.filter(entry => !entry.date.startsWith(currentMonth));
                } else {
                    // Adjust existing entries proportionally
                    const ratio = newTotal / currentTotal;
                    monthlyEntries.forEach(entry => {
                        entry.amount = Math.round(entry.amount * ratio);
                    });
                }
                this.saveData();
            }

            getCurrentEarningRate(days = 30) {
                if (this.salesRateMode === 'manual') {
                    return this.manualSalesRate;
                }
                
                if (this.salesHistory.length === 0) return 0;
                
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                const cutoffDateStr = cutoffDate.toISOString().slice(0, 10);
                
                const recentEntries = this.salesHistory.filter(entry => entry.date >= cutoffDateStr);
                
                if (recentEntries.length === 0) return 0;
                
                const totalRevenue = recentEntries.reduce((sum, entry) => sum + entry.amount, 0);
                const daysCovered = Math.max(1, recentEntries.length); // Prevent division by zero
                
                return totalRevenue / daysCovered;
            }

            calculateWorkingDaysUntilDate(targetDate) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (targetDate <= today) return 0;
                
                let workingDays = 0;
                const current = new Date(today);
                
                while (current < targetDate) {
                    const dayOfWeek = current.getDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Not Sunday (0) or Saturday (6)
                        workingDays++;
                    }
                    current.setDate(current.getDate() + 1);
                }
                
                return workingDays;
            }

            addWorkingDaysToDate(startDate, workingDays) {
                const date = new Date(startDate);
                let daysAdded = 0;
                
                while (daysAdded < workingDays) {
                    date.setDate(date.getDate() + 1);
                    const dayOfWeek = date.getDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Not Sunday or Saturday
                        daysAdded++;
                    }
                }
                
                return date;
            }

            calculateTimeToGoal(goalAmount) {
                const currentRate = this.getCurrentEarningRate();
                if (currentRate <= 0) return Infinity;
                
                const remainingAmount = goalAmount - this.getMonthlyRevenueFromHistory();
                if (remainingAmount <= 0) return 0;
                
                const workingDaysNeeded = Math.ceil(remainingAmount / currentRate);
                const completionDate = this.addWorkingDaysToDate(new Date(), workingDaysNeeded);
                
                return {
                    workingDays: workingDaysNeeded,
                    calendarDays: Math.ceil((completionDate - new Date()) / (1000 * 60 * 60 * 24)),
                    completionDate: completionDate
                };
            }

            autoRecordTodaysRevenue() {
                const today = new Date().toISOString().slice(0, 10);
                if (this.currentDailyRevenue > 0) {
                    this.addSalesEntry(today, this.currentDailyRevenue, 'auto');
                }
            }

            addDailyProgressEntry(date, activity, calls, tasks, revenue) {
                // Remove existing entry for this date if it exists
                this.dailyProgress = (this.dailyProgress || []).filter(entry => entry.date !== date);
                
                // Add new entry
                this.dailyProgress.push({
                    date: date,
                    activity: activity || 0,
                    calls: calls || 0,
                    tasks: tasks || 0,
                    revenue: revenue || 0,
                    timestamp: new Date().toISOString()
                });

                // Sort by date (newest first)
                this.dailyProgress.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                this.saveData();
            }

            getGoalsGroupedByMonth() {
                const goals = this.purchaseGoalManager.getGoalsSorted().filter(goal => !goal.purchased);
                const today = new Date();
                const currentMonth = today.getFullYear() * 12 + today.getMonth();
                
                const grouped = {
                    thisMonth: [],
                    nextMonth: [],
                    futureMonths: []
                };
                
                goals.forEach(goal => {
                    const timeToGoal = this.calculateTimeToGoal(goal.requiredRevenue);
                    if (timeToGoal === Infinity || timeToGoal === 0) {
                        grouped.futureMonths.push(goal);
                        return;
                    }
                    
                    const achievementDate = timeToGoal.completionDate;
                    const goalMonth = achievementDate.getFullYear() * 12 + achievementDate.getMonth();
                    
                    if (goalMonth === currentMonth) {
                        grouped.thisMonth.push(goal);
                    } else if (goalMonth === currentMonth + 1) {
                        grouped.nextMonth.push(goal);
                    } else {
                        grouped.futureMonths.push(goal);
                    }
                });
                
                return grouped;
            }
        }

        let tracker;
        let isEndTimeLocked = true;

        // Initialize when page loads
        window.addEventListener('load', () => {
            tracker = new ActivityTracker();
            populateSalesHistory();
        });

        // Revenue Goals Management Functions

        // Icon Picker Functions
        let currentIconTarget = null;
        let selectedIconType = 'target';
        
        function showIconPicker(target, goalId = null, event = null) {
            if (event) event.stopPropagation();
            
            currentIconTarget = target;
            currentGoalId = goalId;
            
            const picker = document.getElementById('iconPicker');
            const clickX = event ? event.clientX : 200;
            const clickY = event ? event.clientY : 200;
            
            picker.style.left = clickX + 'px';
            picker.style.top = clickY + 'px';
            picker.style.display = 'block';
        }
        
        function selectIcon(iconType) {
            selectedIconType = iconType;
            const icon = GOAL_ICONS[iconType];
            
            if (currentIconTarget === 'new') {
                // Update new goal icon
                document.getElementById('newGoalIconDisplay').textContent = icon;
            } else if (currentIconTarget && currentGoalId) {
                // Update existing goal icon
                const goal = tracker.purchaseGoalManager.goals.find(g => g.id === currentGoalId);
                if (goal) {
                    goal.iconType = iconType;
                    tracker.purchaseGoalManager.save();
                    populatePurchaseGoalsList();
                    updateRevenuePathVisualization();
                }
            }
            
            hideIconPicker();
        }
        
        function hideIconPicker() {
            document.getElementById('iconPicker').style.display = 'none';
            currentIconTarget = null;
            currentGoalId = null;
        }
        
        // Hide icon picker when clicking elsewhere
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#iconPicker') && !e.target.closest('[onclick*="showIconPicker"]')) {
                hideIconPicker();
            }
        });

        function addPurchaseGoal() {
            const nameInput = document.getElementById('newGoalName');
            const costInput = document.getElementById('newGoalCost');
            
            const name = nameInput.value.trim();
            const cost = parseFloat(costInput.value);
            const iconType = selectedIconType;
            
            if (!name) {
                alert('Please enter an item name');
                return;
            }
            
            if (!cost || cost <= 0) {
                alert('Please enter a valid cost');
                return;
            }
            
            const goal = tracker.purchaseGoalManager.addGoal(name, cost);
            // Store the selected icon type with the goal
            goal.iconType = iconType;
            tracker.purchaseGoalManager.save();
            
            // Clear inputs
            nameInput.value = '';
            costInput.value = '';
            selectedIconType = 'target'; // Reset to default
            document.getElementById('newGoalIconDisplay').textContent = GOAL_ICONS.target;
            
            // Refresh display
            populatePurchaseGoalsList();
            updateRevenuePathVisualization();
        }

        function populatePurchaseGoalsList() {
            const container = document.getElementById('purchaseGoalsList');
            const goals = tracker.purchaseGoalManager.getGoalsSorted();
            
            if (goals.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No purchase goals yet. Add one above!</div>';
                return;
            }

            // Check if we should use grouped display
            const purchasedGoals = goals.filter(goal => goal.purchased);
            const unpurchasedGoals = goals.filter(goal => !goal.purchased);
            
            if (unpurchasedGoals.length > 3 || purchasedGoals.length > 0) {
                // Use new grouped layout
                renderGroupedGoalsList(container, goals);
                return;
            }
            
            container.innerHTML = goals.map((goal, index) => {
                const currentRevenue = tracker.currentMonthlyRevenue;
                const goalProgress = tracker.purchaseGoalManager.calculateProgress(currentRevenue).find(g => g.id === goal.id);
                const revenueRemaining = Math.max(0, goalProgress.endRevenue - currentRevenue);
                
                return `
                <div class="goal-item" draggable="${!goal.purchased}" data-goal-id="${goal.id}" 
                     style="display: flex; align-items: center; padding: 6px; border: 1px solid var(--border-color); margin-bottom: 4px; background: ${goal.purchased ? 'var(--bg-accent)' : 'var(--bg-primary)'}; border-radius: 3px; cursor: ${!goal.purchased ? 'move' : 'default'}; color: var(--text-primary);">
                    
                    ${!goal.purchased ? '<div class="drag-handle" style="margin-right: 6px; color: var(--text-muted); cursor: grab;">‚ãÆ‚ãÆ</div>' : ''}
                    
                    <input type="checkbox" ${goal.purchased ? 'checked' : ''} 
                           onchange="toggleGoalPurchased('${goal.id}')"
                           style="margin-right: 6px;">
                    
                    <div style="flex: 1; font-weight: 500; ${goal.purchased ? 'text-decoration: line-through; color: var(--text-secondary);' : ''}">
                        <span onclick="showIconPicker('edit', '${goal.id}', event)" style="margin-right: 6px; font-size: 16px; cursor: pointer; padding: 2px; border-radius: 3px;" title="Click to change icon">${getIconForGoal(goal.name, goal.iconType)}</span>
                        <span onclick="editGoalName('${goal.id}', this)" style="cursor: pointer; padding: 2px; border-radius: 3px;" title="Click to edit name">${goal.name}</span>
                    </div>
                    
                    <div onclick="editGoalCost('${goal.id}', this)" style="font-size: 11px; color: var(--text-secondary); margin-right: 8px; cursor: pointer; padding: 2px; border-radius: 3px;" title="Click to edit cost">$${goal.cost}</div>
                    
                    ${!goal.purchased ? (() => {
                        const timeToGoal = tracker.calculateTimeToGoal(goal.requiredRevenue);
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        
                        if (goalProgress.achieved) {
                            return `<div style="font-size: 9px; color: #28a745; margin-right: 8px; font-weight: 500;">‚úì Complete</div>`;
                        }
                        
                        let timeEstimate, formattedDate, workingDays;
                        if (timeToGoal === Infinity || timeToGoal === 0) {
                            timeEstimate = 'No sales data';
                            formattedDate = 'Date unknown';
                            workingDays = Infinity;
                        } else {
                            const achievementDate = timeToGoal.completionDate;
                            formattedDate = `${monthNames[achievementDate.getMonth()]} ${achievementDate.getDate()}`;
                            workingDays = timeToGoal.workingDays;
                            
                            if (workingDays <= 7) {
                                timeEstimate = `${workingDays} work days`;
                            } else if (workingDays <= 30) {
                                timeEstimate = `${Math.ceil(workingDays/5)} weeks`;
                            } else {
                                timeEstimate = `${Math.ceil(workingDays/22)} months`;
                            }
                        }
                        
                        return `
                            <div style="font-size: 9px; color: var(--text-secondary); margin-right: 8px; line-height: 1.2;">
                                üí∞ $${(revenueRemaining/1000).toFixed(1)}K left ‚Ä¢ ‚è±Ô∏è ${timeEstimate}
                            </div>
                            <div style="font-size: 8px; color: var(--text-muted); margin-right: 8px;">
                                üìÖ ${workingDays === Infinity ? 'Date unknown' : `${formattedDate} (in ${workingDays} work days)`}
                            </div>
                        `;
                    })() : ''}
                    
                    <button onclick="removeGoal('${goal.id}')" 
                            style="background: var(--danger); color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 10px; cursor: pointer;">√ó</button>
                </div>
                `;
            }).join('');
            
            // Add drag and drop functionality
            setupDragAndDrop();
        }

        function renderGroupedGoalsList(container, allGoals) {
            const purchasedGoals = allGoals.filter(goal => goal.purchased);
            const groupedGoals = tracker.getGoalsGroupedByMonth();
            
            let html = '';

            // Museum of Triumphs Section
            if (purchasedGoals.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 13px; display: flex; align-items: center;">
                            ‚úÖ Done
                        </h4>
                        <div style="border-left: 3px solid var(--success); padding-left: 10px; margin-bottom: 15px;">
                `;
                
                // Sort purchased goals by purchase date (most recent first)
                const sortedPurchasedGoals = purchasedGoals.sort((a, b) => {
                    const dateA = a.purchaseDate ? new Date(a.purchaseDate) : new Date(0);
                    const dateB = b.purchaseDate ? new Date(b.purchaseDate) : new Date(0);
                    return dateB - dateA;
                });

                sortedPurchasedGoals.forEach((goal, index) => {
                    const purchaseDate = goal.purchaseDate ? new Date(goal.purchaseDate) : null;
                    const formattedDate = purchaseDate ? purchaseDate.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        year: purchaseDate.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
                    }) : 'Unknown date';
                    
                    html += `
                        <div style="display: flex; align-items: center; padding: 6px; margin-bottom: 4px; background: var(--bg-accent); border-radius: 3px; color: var(--text-primary);">
                            <div style="flex: 1; font-weight: 500;">
                                <span style="margin-right: 6px; font-size: 16px;">${getIconForGoal(goal.name, goal.iconType)}</span>
                                <span style="text-decoration: line-through; color: var(--text-secondary);">‚úÖ ${goal.name}</span>
                                <span style="margin-left: 8px; font-size: 10px; color: var(--text-muted);">üìÖ ${formattedDate}</span>
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-right: 8px;">$${goal.cost}</div>
                            <div style="font-size: 9px; color: var(--success); margin-right: 8px; font-weight: 500;">
                                üèîÔ∏è Mountain #${sortedPurchasedGoals.length - index}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }

            // Current Goals Grouped by Month
            const today = new Date();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);

            if (groupedGoals.thisMonth.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 13px;">
                            üóìÔ∏è THIS MONTH (${monthNames[today.getMonth()]} ${today.getFullYear()})
                        </h4>
                        <div style="border-left: 3px solid var(--primary); padding-left: 10px;">
                `;
                html += renderGoalItems(groupedGoals.thisMonth);
                html += '</div></div>';
            }

            if (groupedGoals.nextMonth.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 13px;">
                            üìÖ NEXT MONTH (${monthNames[nextMonth.getMonth()]} ${nextMonth.getFullYear()})
                        </h4>
                        <div style="border-left: 3px solid var(--primary-light); padding-left: 10px;">
                `;
                html += renderGoalItems(groupedGoals.nextMonth);
                html += '</div></div>';
            }

            if (groupedGoals.futureMonths.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 13px;">
                            üîÆ FUTURE GOALS
                        </h4>
                        <div style="border-left: 3px solid var(--text-muted); padding-left: 10px;">
                `;
                html += renderGoalItems(groupedGoals.futureMonths);
                html += '</div></div>';
            }

            container.innerHTML = html;
            setupDragAndDrop();
        }

        function renderGoalItems(goals) {
            return goals.map((goal, index) => {
                const currentRevenue = tracker.currentMonthlyRevenue;
                const goalProgress = tracker.purchaseGoalManager.calculateProgress(currentRevenue).find(g => g.id === goal.id);
                const revenueRemaining = Math.max(0, goalProgress.endRevenue - currentRevenue);
                
                const daysToGoal = tracker.calculateTimeToGoal(goal.requiredRevenue);
                const achievementDate = new Date();
                achievementDate.setDate(achievementDate.getDate() + daysToGoal);
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const formattedDate = `${monthNames[achievementDate.getMonth()]} ${achievementDate.getDate()}`;
                
                const timeEstimate = (() => {
                    if (daysToGoal === Infinity) return 'No sales data';
                    if (daysToGoal <= 7) return `${daysToGoal} days`;
                    if (daysToGoal <= 60) return `${Math.ceil(daysToGoal/7)} weeks`;
                    return `${Math.ceil(daysToGoal/30)} months`;
                })();

                return `
                <div class="goal-item" draggable="true" data-goal-id="${goal.id}" 
                     style="display: flex; align-items: center; padding: 6px; border: 1px solid var(--border-color); margin-bottom: 4px; background: var(--bg-primary); border-radius: 3px; cursor: move; color: var(--text-primary);">
                    
                    <div class="drag-handle" style="margin-right: 6px; color: var(--text-muted); cursor: grab;">‚ãÆ‚ãÆ</div>
                    
                    <input type="checkbox" onchange="toggleGoalPurchased('${goal.id}')" style="margin-right: 6px;">
                    
                    <div style="flex: 1; font-weight: 500;">
                        <span onclick="showIconPicker('edit', '${goal.id}', event)" style="margin-right: 6px; font-size: 16px; cursor: pointer; padding: 2px; border-radius: 3px;" title="Click to change icon">${getIconForGoal(goal.name, goal.iconType)}</span>
                        <span onclick="editGoalName('${goal.id}', this)" style="cursor: pointer; padding: 2px; border-radius: 3px;" title="Click to edit name">${goal.name}</span>
                    </div>
                    
                    <div onclick="editGoalCost('${goal.id}', this)" style="font-size: 11px; color: var(--text-secondary); margin-right: 8px; cursor: pointer; padding: 2px; border-radius: 3px;" title="Click to edit cost">$${goal.cost}</div>
                    
                    <div style="text-align: right; margin-right: 8px;">
                        <div style="font-size: 9px; color: var(--text-secondary); line-height: 1.2;">
                            üí∞ $${(revenueRemaining/1000).toFixed(1)}K left ‚Ä¢ ‚è±Ô∏è ${timeEstimate}
                        </div>
                        <div style="font-size: 8px; color: var(--text-muted);">
                            üìÖ ${workingDays === Infinity ? 'Date unknown' : `${formattedDate} (in ${workingDays} work days)`}
                        </div>
                    </div>
                    
                    <button onclick="removeGoal('${goal.id}')" 
                            style="background: var(--danger); color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 10px; cursor: pointer;">√ó</button>
                </div>
                `;
            }).join('');
        }

        function setupDragAndDrop() {
            const goalItems = document.querySelectorAll('.goal-item[draggable="true"]');
            
            goalItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.style.opacity = '0.5';
        }

        function handleDragOver(e) {
            e.preventDefault();
            
            // Determine if we're dropping above or below the target
            const rect = this.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            
            // Clear all borders first
            document.querySelectorAll('.goal-item').forEach(item => {
                item.style.borderTop = '';
                item.style.borderBottom = '';
            });
            
            if (e.clientY < midY) {
                this.style.borderTop = '2px solid #007acc';
                this.dropPosition = 'above';
            } else {
                this.style.borderBottom = '2px solid #007acc';
                this.dropPosition = 'below';
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            
            // Clear all borders
            document.querySelectorAll('.goal-item').forEach(item => {
                item.style.borderTop = '';
                item.style.borderBottom = '';
            });
            
            if (draggedElement !== this) {
                const draggedId = draggedElement.dataset.goalId;
                const targetId = this.dataset.goalId;
                
                const allItems = Array.from(document.querySelectorAll('.goal-item'));
                const draggedIndex = allItems.findIndex(item => item.dataset.goalId === draggedId);
                const targetIndex = allItems.findIndex(item => item.dataset.goalId === targetId);
                
                if (draggedIndex !== -1 && targetIndex !== -1) {
                    let newIndex = targetIndex;
                    
                    // Adjust for drop position
                    if (this.dropPosition === 'below') {
                        newIndex = targetIndex + 1;
                    }
                    
                    // Adjust for array shift when moving down
                    if (draggedIndex < newIndex) {
                        newIndex = newIndex - 1;
                    }
                    
                    tracker.purchaseGoalManager.moveGoal(draggedIndex, newIndex);
                    populatePurchaseGoalsList();
                    updateRevenuePathVisualization();
                }
            }
        }

        function handleDragEnd(e) {
            this.style.opacity = '';
            document.querySelectorAll('.goal-item').forEach(item => {
                item.style.borderTop = '';
                item.style.borderBottom = '';
            });
        }

        function toggleGoalPurchased(goalId) {
            const goal = tracker.purchaseGoalManager.goals.find(g => g.id === goalId);
            if (goal) {
                tracker.purchaseGoalManager.updateGoal(goalId, { purchased: !goal.purchased });
                populatePurchaseGoalsList();
                updateRevenuePathVisualization();
            }
        }

        function removeGoal(goalId) {
            if (confirm('Remove this purchase goal?')) {
                tracker.purchaseGoalManager.removeGoal(goalId);
                populatePurchaseGoalsList();
                updateRevenuePathVisualization();
            }
        }

        function editGoalName(goalId, element) {
            const goal = tracker.purchaseGoalManager.goals.find(g => g.id === goalId);
            if (!goal) return;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = goal.name;
            input.style.cssText = 'border: 1px solid #007acc; padding: 2px 4px; border-radius: 3px; font-size: inherit; font-weight: inherit; background: var(--bg-primary);';
            
            const originalText = element.textContent;
            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
            input.select();
            
            function saveEdit() {
                const newName = input.value.trim();
                if (newName && newName !== goal.name) {
                    tracker.purchaseGoalManager.updateGoal(goalId, { name: newName });
                    populatePurchaseGoalsList();
                    updateRevenuePathVisualization();
                } else {
                    element.textContent = originalText;
                }
            }
            
            function cancelEdit() {
                element.textContent = originalText;
            }
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });
        }

        function editGoalCost(goalId, element) {
            const goal = tracker.purchaseGoalManager.goals.find(g => g.id === goalId);
            if (!goal) return;
            
            const input = document.createElement('input');
            input.type = 'number';
            input.value = goal.cost;
            input.min = '1';
            input.step = '1';
            input.style.cssText = 'border: 1px solid #007acc; padding: 2px 4px; border-radius: 3px; font-size: inherit; background: var(--bg-primary); width: 60px; -moz-appearance: textfield;';
            // Hide webkit spinners
            const style = document.createElement('style');
            style.textContent = 'input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }';
            document.head.appendChild(style);
            
            const originalText = element.textContent;
            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
            input.select();
            
            function saveEdit() {
                const newCost = parseInt(input.value);
                if (newCost && newCost > 0 && newCost !== goal.cost) {
                    const newRequiredRevenue = Math.round(tracker.purchaseGoalManager.calculator.calculateRevenueForPurchase(newCost));
                    tracker.purchaseGoalManager.updateGoal(goalId, { 
                        cost: newCost, 
                        requiredRevenue: newRequiredRevenue 
                    });
                    populatePurchaseGoalsList();
                    updateRevenuePathVisualization();
                } else {
                    element.innerHTML = originalText;
                }
            }
            
            function cancelEdit() {
                element.innerHTML = originalText;
            }
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });
        }

        function updateCommissionSettings() {
            const commissionRate = (parseFloat(document.getElementById('commissionRate').value) || 0.25) / 100;
            const taxRate = (parseFloat(document.getElementById('taxRate').value) || 32.5) / 100;
            
            tracker.purchaseGoalManager.calculator = new RevenueCalculator(commissionRate, taxRate);
            
            // Recalculate all required revenues
            tracker.purchaseGoalManager.goals.forEach(goal => {
                goal.requiredRevenue = Math.round(tracker.purchaseGoalManager.calculator.calculateRevenueForPurchase(goal.cost));
            });
            tracker.purchaseGoalManager.save();
            
            // Refresh displays
            populatePurchaseGoalsList();
            updateRevenuePathVisualization();
            
            // Show subtle save indication
            const button = document.querySelector('button[onclick*="updateCommissionSettings"]');
            const originalText = button.textContent;
            button.textContent = 'Saved ‚úì';
            button.style.background = '#28a745';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 2000);
        }

        function updateRevenuePathVisualization() {
            try {
                const pathContainer = document.getElementById('revenuePath');
                const labelsContainer = document.getElementById('revenuePathLabels');
                
                const currentRevenue = tracker.currentMonthlyRevenue;
                const goals = tracker.purchaseGoalManager.calculateProgress(currentRevenue);
            
            if (goals.length === 0) {
                pathContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">No goals to visualize</div>';
                labelsContainer.innerHTML = '';
                return;
            }
            
            // Use monthly revenue target as the scale, same as main screen
            const monthlyTarget = tracker.monthlyRevenueTarget;
            
            // Separate goals that fit within monthly target vs beyond
            const currentMonthMilestones = [];
            const futureGoalsList = [];
            
            goals.forEach(goal => {
                const position = (goal.endRevenue / monthlyTarget) * 100;
                const icon = getIconForGoal(goal.name, goal.iconType);
                
                let statusClass = '';
                if (goal.purchased) statusClass = 'purchased';
                else if (goal.achieved) statusClass = 'achieved';
                else if (goal.progress > 0) statusClass = 'in-progress';
                else statusClass = 'pending';
                
                const milestone = {
                    goal,
                    position: Math.min(100, position),
                    icon,
                    statusClass
                };
                
                if (position <= 100) {
                    currentMonthMilestones.push(milestone);
                } else {
                    futureGoalsList.push(milestone);
                }
            });
            
            // Use only current month milestones for the main visualization
            const milestones = currentMonthMilestones;
            
            // Find next goal (first unachieved goal)
            const nextGoal = milestones.find(milestone => !milestone.goal.achieved);
            
            // Create base progress bar
            const progressPercent = Math.min((currentRevenue / monthlyTarget) * 100, 100);
            
            // Render progress bar with milestone icons
            pathContainer.innerHTML = `
                <!-- Base progress bar -->
                <div style="position: absolute; top: 20px; left: 0; right: 0; height: 20px; background: #e0e0e0; border-radius: 10px;">
                    <div style="height: 100%; width: ${progressPercent}%; background: linear-gradient(to right, #007acc, #4dc3ff); border-radius: 10px; transition: width 0.3s ease;"></div>
                </div>
                
                <!-- Milestone icons -->
                ${milestones.map(milestone => `
                    <div style="position: absolute; left: ${milestone.position}%; top: 30px; transform: translate(-50%, -50%); z-index: 10;">
                        <div class="milestone-icon ${milestone.statusClass}" 
                             style="font-size: 24px; text-shadow: 0 0 3px rgba(0,0,0,0.3); cursor: pointer;
                                    filter: ${milestone.statusClass === 'purchased' ? 'brightness(1.2)' : 
                                             milestone.statusClass === 'achieved' ? 'brightness(1.1) sepia(1) hue-rotate(25deg)' : 
                                             milestone.statusClass === 'in-progress' ? 'brightness(1)' : 'grayscale(0.7) brightness(0.8)'}"
                             title="${milestone.goal.name}: $${milestone.goal.cost.toLocaleString()} (${milestone.statusClass})">
                            ${milestone.icon}
                            ${milestone === nextGoal && !milestone.goal.achieved ? `
                                <div style="
                                    position: absolute;
                                    top: 25px;
                                    left: 50%;
                                    transform: translateX(-50%);
                                    background: rgba(0, 122, 204, 0.9);
                                    color: white;
                                    padding: 2px 6px;
                                    border-radius: 8px;
                                    font-size: 10px;
                                    white-space: nowrap;
                                    z-index: 15;
                                    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                                ">
                                    $${((milestone.goal.endRevenue - currentRevenue)/1000).toFixed(1)}K to go (${(((currentRevenue) / milestone.goal.endRevenue) * 100).toFixed(0)}%)
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
                
                <!-- Current position indicator -->
                <div style="position: absolute; left: ${progressPercent}%; top: 15px; transform: translateX(-50%); z-index: 15;">
                    <div style="width: 3px; height: 30px; background: red; border-radius: 2px; box-shadow: 0 0 5px rgba(255,0,0,0.5);" title="Current Revenue: $${currentRevenue.toLocaleString()}"></div>
                </div>
                
                <!-- Month progress indicator -->
                ${(() => {
                    const now = new Date();
                    const currentDay = now.getDate();
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    const monthProgress = (currentDay - 1) / (daysInMonth - 1);
                    const monthProgressPercent = Math.min(100, monthProgress * 100);
                    
                    return `
                    <div style="position: absolute; left: ${monthProgressPercent}%; top: 0px; transform: translateX(-50%); z-index: 16;">
                        <div style="width: 2px; height: 60px; background: var(--primary); border-radius: 1px; box-shadow: 0 0 3px rgba(0,122,204,0.5);" title="Month Progress: Day ${currentDay} of ${daysInMonth}"></div>
                    </div>
                    `;
                })()}
            `;
            
            // Render labels with icons - current month goals first
            const currentMonthLabels = currentMonthMilestones.map(milestone => `
                <span style="display: inline-block; margin-right: 12px; font-size: 10px; white-space: nowrap;">
                    <span style="font-size: 14px; margin-right: 4px; vertical-align: middle;">${milestone.icon}</span>
                    ${milestone.goal.name} ($${(milestone.goal.requiredRevenue/1000).toFixed(1)}K)
                    ${milestone.goal.purchased ? '‚úì' : milestone.goal.achieved ? '‚òÖ' : ''}
                </span>
            `).join('');
            
            // Add future goals section if any exist
            const futureGoalsSection = futureGoalsList.length > 0 ? `
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-light);">
                    <div style="font-size: 9px; color: #999; margin-bottom: 4px;">FUTURE GOALS (beyond this month):</div>
                    ${futureGoalsList.map(milestone => `
                        <span style="display: inline-block; margin-right: 12px; font-size: 10px; white-space: nowrap; opacity: 0.7;">
                            <span style="font-size: 14px; margin-right: 4px; vertical-align: middle; filter: grayscale(30%);">${milestone.icon}</span>
                            ${milestone.goal.name} ($${(milestone.goal.requiredRevenue/1000).toFixed(1)}K)
                            ${milestone.goal.purchased ? '‚úì' : ''}
                        </span>
                    `).join('')}
                </div>
            ` : '';
            
            labelsContainer.innerHTML = currentMonthLabels + futureGoalsSection;
            } catch (error) {
                console.error('Error in updateRevenuePathVisualization:', error);
            }
        }



        function toggleEndTimeLock() {
            const startTimeInput = document.getElementById('startTimeInput');
            const endTimeInput = document.getElementById('endTimeInput');
            const lockButton = document.getElementById('lockButton');
            
            isEndTimeLocked = !isEndTimeLocked;
            
            if (isEndTimeLocked) {
                endTimeInput.readOnly = true;
                endTimeInput.style.background = '#f8f8f8';
                lockButton.textContent = 'üîí';
                updateEndTime();
            } else {
                endTimeInput.readOnly = false;
                endTimeInput.style.background = 'white';
                lockButton.textContent = 'üîì';
            }
        }

        function updateEndTime() {
            if (isEndTimeLocked) {
                const startTime = document.getElementById('startTimeInput').value;
                if (startTime) {
                    const [hours, minutes] = startTime.split(':').map(Number);
                    const endHours = (hours + 8) % 24;
                    const endTime = endHours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0');
                    document.getElementById('endTimeInput').value = endTime;
                }
            }
        }

        // Update end time when start time changes (if locked)
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('startTimeInput').addEventListener('change', updateEndTime);
        });

        // Backup System using File System Access API
        async function exportBackup() {
            try {
                // Check if File System Access API is supported
                if (!window.showSaveFilePicker) {
                    alert('File System Access API not supported. Use a Chromium-based browser.');
                    return;
                }

                // Gather all data
                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: "1.0",
                    tracker: {
                        currentValues: {
                            activity: tracker.currentPoints,
                            calls: tracker.currentCalls,
                            backlog: tracker.currentBacklog
                        },
                        targets: {
                            activityTarget: tracker.target,
                            callsTarget: tracker.callsTarget,
                            backlogTarget: tracker.backlogTarget
                        },
                        workTime: {
                            start: tracker.shiftStart,
                            end: tracker.shiftEnd
                        },
                        salesHistory: tracker.salesHistory,
                        dailyProgress: tracker.dailyProgress,
                        purchaseGoals: tracker.purchaseGoalManager.goals.map(goal => ({
                            id: goal.id,
                            name: goal.name,
                            cost: goal.cost,
                            iconType: goal.iconType,
                            purchased: goal.purchased,
                            purchaseDate: goal.purchaseDate,
                            requiredRevenue: goal.requiredRevenue
                        })),
                        commissionSettings: {
                            commissionRate: tracker.purchaseGoalManager.calculator.commissionRate,
                            taxRate: tracker.purchaseGoalManager.calculator.taxRate
                        },
                        salesRateSettings: {
                            salesRateMode: tracker.salesRateMode,
                            manualSalesRate: tracker.manualSalesRate
                        }
                    }
                };

                // Create file picker options
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: `sales-tracker-backup-${new Date().toISOString().split('T')[0]}.json`,
                    types: [{
                        description: 'JSON backup files',
                        accept: { 'application/json': ['.json'] }
                    }]
                });

                // Write the data
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(backupData, null, 2));
                await writable.close();

                alert('Backup exported successfully!');
            } catch (error) {
                if (error.name === 'AbortError') {
                    // User cancelled, no need to show error
                    return;
                }
                console.error('Error exporting backup:', error);
                alert('Error exporting backup: ' + error.message);
            }
        }

        async function importBackup() {
            try {
                // Check if File System Access API is supported
                if (!window.showOpenFilePicker) {
                    alert('File System Access API not supported. Use a Chromium-based browser.');
                    return;
                }

                const fileHandles = await window.showOpenFilePicker({
                    types: [{
                        description: 'JSON backup files',
                        accept: { 'application/json': ['.json'] }
                    }]
                });

                const file = await fileHandles[0].getFile();
                const text = await file.text();
                const backupData = JSON.parse(text);

                // Validate backup data structure
                if (!backupData.tracker) {
                    throw new Error('Invalid backup file format');
                }

                const data = backupData.tracker;

                // Restore tracker values
                if (data.currentValues) {
                    tracker.currentPoints = data.currentValues.activity || 0;
                    tracker.currentCalls = data.currentValues.calls || 0;
                    tracker.currentBacklog = data.currentValues.backlog || 0;
                }

                if (data.targets) {
                    tracker.target = data.targets.activityTarget || 50;
                    tracker.callsTarget = data.targets.callsTarget || 20;
                    tracker.backlogTarget = data.targets.backlogTarget || 0;
                }

                if (data.workTime) {
                    tracker.shiftStart = data.workTime.start || '09:00';
                    tracker.shiftEnd = data.workTime.end || '17:00';
                }

                // Restore sales history and daily progress
                if (data.salesHistory) {
                    tracker.salesHistory = data.salesHistory;
                }
                if (data.dailyProgress) {
                    tracker.dailyProgress = data.dailyProgress;
                }

                // Restore commission settings
                if (data.commissionSettings) {
                    tracker.purchaseGoalManager.calculator.commissionRate = data.commissionSettings.commissionRate || 0.0025;
                    tracker.purchaseGoalManager.calculator.taxRate = data.commissionSettings.taxRate || 0.325;
                }

                // Restore sales rate settings
                if (data.salesRateSettings) {
                    tracker.salesRateMode = data.salesRateSettings.salesRateMode || 'auto';
                    tracker.manualSalesRate = data.salesRateSettings.manualSalesRate || 1000;
                }

                // Restore purchase goals
                if (data.purchaseGoals) {
                    tracker.purchaseGoalManager.goals = data.purchaseGoals.map(goalData => {
                        const goal = tracker.purchaseGoalManager.addGoal(goalData.name, goalData.cost);
                        goal.id = goalData.id;
                        goal.iconType = goalData.iconType || 'target';
                        goal.purchased = goalData.purchased || false;
                        goal.purchaseDate = goalData.purchaseDate;
                        goal.requiredRevenue = goalData.requiredRevenue;
                        return goal;
                    });
                    // Remove the extra goal that addGoal() creates
                    tracker.purchaseGoalManager.goals = tracker.purchaseGoalManager.goals.slice(0, data.purchaseGoals.length);
                }

                // Save all restored data
                tracker.save();
                tracker.purchaseGoalManager.save();

                // Refresh the display
                tracker.updateDisplay();
                if (tracker.currentMenu === 'goals') {
                    populateGoalsPage();
                    populatePurchaseGoalsList();
                    updateRevenuePathVisualization();
                }

                alert(`Backup imported successfully! (from ${new Date(backupData.timestamp).toLocaleString()})`);
            } catch (error) {
                if (error.name === 'AbortError') {
                    // User cancelled, no need to show error
                    return;
                }
                console.error('Error importing backup:', error);
                alert('Error importing backup: ' + error.message);
            }
        }
    </script>
</body>
</html>